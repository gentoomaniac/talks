# Scaling Event Sourcing for Netflix Downloads (2017-09-12)

![alt Scaling Event Sourcing for Netflix Downloads](img/rsSld8NycCU.jpg "Scaling Event Sourcing for Netflix Downloads")

## Description

QCon New York International Software Conference returns this June 13-15. Technical leaders who are driving innovation and change in software will share the latest trends and techniques from their real-world projects to help you solve common challenges. 

More than 800 software professionals will join together and learn about the emerging trends they should pay attention to in 2023, how to adopt them, how to avoid pitfalls, and how to embrace the best practices. Join the experience and get implementable ideas to shape your projects that last beyond the conference.

Attend in-person or online on June 13-15, 2023. Register now: http://bit.ly/3wq3yBs 
-------------------------------------------------------------------------------------------
Download the slides & audio at InfoQ: http://bit.ly/2vR9LFE  

Phillipa Avery and Robert Reta describe how Netflix successfully launched their Download feature with the use of a Cassandra-backed event sourcing architecture. They describe their event store implementation and cover what they learned along the way, and what they could have done better. Finally, they review some improvements and extensions that they are planning to address going forward.

## Transcript

[0:00:03](https://youtu.be/rsSld8NycCU?t=3) I'm gonna start with a raise of hands  
[0:00:06](https://youtu.be/rsSld8NycCU?t=6) cuz why not it's fun how many people  
[0:00:08](https://youtu.be/rsSld8NycCU?t=8) here have used the new Netflix download  
[0:00:11](https://youtu.be/rsSld8NycCU?t=11) feature that's a nice show of hands all  
[0:00:14](https://youtu.be/rsSld8NycCU?t=14) right keep your hands up please  
[0:00:16](https://youtu.be/rsSld8NycCU?t=16) alright so those of you who use the  
[0:00:18](https://youtu.be/rsSld8NycCU?t=18) feature how many of you have you  
[0:00:20](https://youtu.be/rsSld8NycCU?t=20) experienced a downloads limitation error  
[0:00:22](https://youtu.be/rsSld8NycCU?t=22) ah all right  
[0:00:25](https://youtu.be/rsSld8NycCU?t=25) hands down thank you so the reason I'm  
[0:00:27](https://youtu.be/rsSld8NycCU?t=27) asking that is today we're going to talk  
[0:00:29](https://youtu.be/rsSld8NycCU?t=29) about the service that backs the  
[0:00:31](https://youtu.be/rsSld8NycCU?t=31) download feature that validates whether  
[0:00:34](https://youtu.be/rsSld8NycCU?t=34) you can actually download content based  
[0:00:37](https://youtu.be/rsSld8NycCU?t=37) on the new business restrictions that  
[0:00:38](https://youtu.be/rsSld8NycCU?t=38) came with downloads so Who am I  
[0:00:41](https://youtu.be/rsSld8NycCU?t=41) my name is Philip Avery I'm a senior  
[0:00:44](https://youtu.be/rsSld8NycCU?t=44) software engineer at Netflix I was the  
[0:00:46](https://youtu.be/rsSld8NycCU?t=46) project tech need lead and one of the  
[0:00:48](https://youtu.be/rsSld8NycCU?t=48) engineers on the Downloads license  
[0:00:50](https://youtu.be/rsSld8NycCU?t=50) accounting project this is my colleague  
[0:00:53](https://youtu.be/rsSld8NycCU?t=53) Robert Ritter  
[0:00:54](https://youtu.be/rsSld8NycCU?t=54) he was the event sourcing system  
[0:00:56](https://youtu.be/rsSld8NycCU?t=56) architect on the event sourcing project  
[0:00:58](https://youtu.be/rsSld8NycCU?t=58) so to start with let's go back in time  
[0:01:01](https://youtu.be/rsSld8NycCU?t=61) back to November 2016 this is a lovely  
[0:01:05](https://youtu.be/rsSld8NycCU?t=65) picture of us sitting in the war room on  
[0:01:07](https://youtu.be/rsSld8NycCU?t=67) the day that downloads was released  
[0:01:09](https://youtu.be/rsSld8NycCU?t=69) there's Robert there's myself sitting in  
[0:01:13](https://youtu.be/rsSld8NycCU?t=73) the front row waiting nervously as  
[0:01:15](https://youtu.be/rsSld8NycCU?t=75) within minutes of this photo all around  
[0:01:18](https://youtu.be/rsSld8NycCU?t=78) the world press releases we're going to  
[0:01:20](https://youtu.be/rsSld8NycCU?t=80) go out to Fame Netflix customers you can  
[0:01:23](https://youtu.be/rsSld8NycCU?t=83) now download content onto your device  
[0:01:25](https://youtu.be/rsSld8NycCU?t=85) awesome scary the reason why it's scary  
[0:01:29](https://youtu.be/rsSld8NycCU?t=89) is here's us watching to see our license  
[0:01:33](https://youtu.be/rsSld8NycCU?t=93) validation service come online and take  
[0:01:36](https://youtu.be/rsSld8NycCU?t=96) traffic for the first time ever so the  
[0:01:40](https://youtu.be/rsSld8NycCU?t=100) way Netflix wanted to release this  
[0:01:41](https://youtu.be/rsSld8NycCU?t=101) service the feature was that they wanted  
[0:01:44](https://youtu.be/rsSld8NycCU?t=104) customers to experience the ability to  
[0:01:46](https://youtu.be/rsSld8NycCU?t=106) download everywhere globally at once for  
[0:01:50](https://youtu.be/rsSld8NycCU?t=110) us that meant no rollout testing no  
[0:01:54](https://youtu.be/rsSld8NycCU?t=114) global testing not even friends and  
[0:01:57](https://youtu.be/rsSld8NycCU?t=117) family testing everyone experience at  
[0:02:00](https://youtu.be/rsSld8NycCU?t=120) the same time our service was about to  
[0:02:02](https://youtu.be/rsSld8NycCU?t=122) take traffic for the first time ever no  
[0:02:05](https://youtu.be/rsSld8NycCU?t=125) pressure so what I'm going to talk about  
[0:02:09](https://youtu.be/rsSld8NycCU?t=129) today is why we needed this new download  
[0:02:12](https://youtu.be/rsSld8NycCU?t=132) service let's talk about the problem  
[0:02:14](https://youtu.be/rsSld8NycCU?t=134) statement secondly we're going to give a  
[0:02:16](https://youtu.be/rsSld8NycCU?t=136) bit of an event sourcing over  
[0:02:17](https://youtu.be/rsSld8NycCU?t=137) for those of you who are new to event  
[0:02:19](https://youtu.be/rsSld8NycCU?t=139) sourcing before deep diving into how we  
[0:02:21](https://youtu.be/rsSld8NycCU?t=141) implemented the architecture for our  
[0:02:23](https://youtu.be/rsSld8NycCU?t=143) event sourcing system finally we're  
[0:02:25](https://youtu.be/rsSld8NycCU?t=145) going to come back out of this and talk  
[0:02:27](https://youtu.be/rsSld8NycCU?t=147) about what it was like as an engineer  
[0:02:29](https://youtu.be/rsSld8NycCU?t=149) after release of this service to  
[0:02:31](https://youtu.be/rsSld8NycCU?t=151) continuously work on it and iterate on  
[0:02:33](https://youtu.be/rsSld8NycCU?t=153) the business requirements so to start  
[0:02:37](https://youtu.be/rsSld8NycCU?t=157) with I'm going to give you an overview  
[0:02:38](https://youtu.be/rsSld8NycCU?t=158) of what the streaming playback lifecycle  
[0:02:40](https://youtu.be/rsSld8NycCU?t=160) is I'm going to do this so that we can  
[0:02:42](https://youtu.be/rsSld8NycCU?t=162) then compare it to the downloads and you  
[0:02:44](https://youtu.be/rsSld8NycCU?t=164) can see how the requirements are  
[0:02:46](https://youtu.be/rsSld8NycCU?t=166) different so when you press play on your  
[0:02:48](https://youtu.be/rsSld8NycCU?t=168) device and you go to streams and content  
[0:02:50](https://youtu.be/rsSld8NycCU?t=170) the first thing you're going to get is a  
[0:02:52](https://youtu.be/rsSld8NycCU?t=172) playback context this gives you the  
[0:02:54](https://youtu.be/rsSld8NycCU?t=174) metadata for your playback it gives you  
[0:02:56](https://youtu.be/rsSld8NycCU?t=176) the URLs that you need for streaming it  
[0:02:58](https://youtu.be/rsSld8NycCU?t=178) gives you information such as the  
[0:03:00](https://youtu.be/rsSld8NycCU?t=180) language that you're going to be using  
[0:03:01](https://youtu.be/rsSld8NycCU?t=181) after you've got that you can go and get  
[0:03:03](https://youtu.be/rsSld8NycCU?t=183) the license the license allows you to  
[0:03:06](https://youtu.be/rsSld8NycCU?t=186) decrypt the encrypted content on the  
[0:03:08](https://youtu.be/rsSld8NycCU?t=188) flyer and buff it up then as you play  
[0:03:11](https://youtu.be/rsSld8NycCU?t=191) we're going to generate session events  
[0:03:13](https://youtu.be/rsSld8NycCU?t=193) that get sent up to our server these  
[0:03:15](https://youtu.be/rsSld8NycCU?t=195) tell us how the playback experience is  
[0:03:17](https://youtu.be/rsSld8NycCU?t=197) going for you then when you press stop  
[0:03:19](https://youtu.be/rsSld8NycCU?t=199) we get a couple events telling us that  
[0:03:22](https://youtu.be/rsSld8NycCU?t=202) the license has been closed and that  
[0:03:23](https://youtu.be/rsSld8NycCU?t=203) you've now closed the session so how  
[0:03:26](https://youtu.be/rsSld8NycCU?t=206) does this compare to downloads it's  
[0:03:28](https://youtu.be/rsSld8NycCU?t=208) pretty similar to start with you press  
[0:03:30](https://youtu.be/rsSld8NycCU?t=210) download again we generate that playback  
[0:03:32](https://youtu.be/rsSld8NycCU?t=212) context with that metadata then we also  
[0:03:34](https://youtu.be/rsSld8NycCU?t=214) generate a license but now the license  
[0:03:37](https://youtu.be/rsSld8NycCU?t=217) is slightly different in the downloads  
[0:03:39](https://youtu.be/rsSld8NycCU?t=219) case that license can be persisted on  
[0:03:42](https://youtu.be/rsSld8NycCU?t=222) the device and used over and over again  
[0:03:44](https://youtu.be/rsSld8NycCU?t=224) in streaming it gives used once and then  
[0:03:46](https://youtu.be/rsSld8NycCU?t=226) it's gone now you can use it over and  
[0:03:48](https://youtu.be/rsSld8NycCU?t=228) over again and then you can actually  
[0:03:51](https://youtu.be/rsSld8NycCU?t=231) download the entire encrypted content  
[0:03:53](https://youtu.be/rsSld8NycCU?t=233) and store it on the device once you have  
[0:03:56](https://youtu.be/rsSld8NycCU?t=236) these you can now start the life cycle  
[0:03:58](https://youtu.be/rsSld8NycCU?t=238) and that life cycle can now laughte  
[0:04:00](https://youtu.be/rsSld8NycCU?t=240) a year so you can have content on your  
[0:04:04](https://youtu.be/rsSld8NycCU?t=244) device and it can stay on your device  
[0:04:06](https://youtu.be/rsSld8NycCU?t=246) for a year you can press play repeatedly  
[0:04:08](https://youtu.be/rsSld8NycCU?t=248) every time you press play wegend gonna  
[0:04:11](https://youtu.be/rsSld8NycCU?t=251) generate session events again and then  
[0:04:12](https://youtu.be/rsSld8NycCU?t=252) the next time you come online we're  
[0:04:13](https://youtu.be/rsSld8NycCU?t=253) gonna send them up to the server so we  
[0:04:15](https://youtu.be/rsSld8NycCU?t=255) can still see how your playback  
[0:04:17](https://youtu.be/rsSld8NycCU?t=257) experience is like and then at some  
[0:04:19](https://youtu.be/rsSld8NycCU?t=259) point in the future about 30 days after  
[0:04:21](https://youtu.be/rsSld8NycCU?t=261) that initial download that license  
[0:04:23](https://youtu.be/rsSld8NycCU?t=263) you've got is going to expire you can  
[0:04:25](https://youtu.be/rsSld8NycCU?t=265) then potentially renew that license  
[0:04:28](https://youtu.be/rsSld8NycCU?t=268) which means the exploration is extended  
[0:04:29](https://youtu.be/rsSld8NycCU?t=269) for another 30 days or so  
[0:04:31](https://youtu.be/rsSld8NycCU?t=271) the ability to renew that is actually  
[0:04:33](https://youtu.be/rsSld8NycCU?t=273) dependent on some of the business  
[0:04:34](https://youtu.be/rsSld8NycCU?t=274) requirements going to talk about in a  
[0:04:35](https://youtu.be/rsSld8NycCU?t=275) second then lastly when you finish with  
[0:04:38](https://youtu.be/rsSld8NycCU?t=278) the content and you delete it off your  
[0:04:40](https://youtu.be/rsSld8NycCU?t=280) device we get a signal telling us that  
[0:04:42](https://youtu.be/rsSld8NycCU?t=282) you've released the license it's no  
[0:04:44](https://youtu.be/rsSld8NycCU?t=284) longer being used and you can  
[0:04:45](https://youtu.be/rsSld8NycCU?t=285) potentially free up another slot to  
[0:04:47](https://youtu.be/rsSld8NycCU?t=287) download more content alright so now  
[0:04:50](https://youtu.be/rsSld8NycCU?t=290) that we've talked about what the life  
[0:04:51](https://youtu.be/rsSld8NycCU?t=291) cycle is and how the differents are  
[0:04:53](https://youtu.be/rsSld8NycCU?t=293) between the downloads and light and  
[0:04:54](https://youtu.be/rsSld8NycCU?t=294) streaming we have different business  
[0:04:56](https://youtu.be/rsSld8NycCU?t=296) requirements which are there for the  
[0:04:59](https://youtu.be/rsSld8NycCU?t=299) Downloads life cycle we have different  
[0:05:02](https://youtu.be/rsSld8NycCU?t=302) business requirements that are Netflix  
[0:05:04](https://youtu.be/rsSld8NycCU?t=304) clients as well as studio requirements  
[0:05:06](https://youtu.be/rsSld8NycCU?t=306) so let's go through some of these one of  
[0:05:09](https://youtu.be/rsSld8NycCU?t=309) the climate's we have is that you're  
[0:05:10](https://youtu.be/rsSld8NycCU?t=310) only allowed to have a certain number of  
[0:05:12](https://youtu.be/rsSld8NycCU?t=312) devices at any point in time with  
[0:05:14](https://youtu.be/rsSld8NycCU?t=314) downloads on them this means we need to  
[0:05:16](https://youtu.be/rsSld8NycCU?t=316) keep track of what devices a customer  
[0:05:19](https://youtu.be/rsSld8NycCU?t=319) currently has and what downloads are on  
[0:05:20](https://youtu.be/rsSld8NycCU?t=320) that device secondly you're only  
[0:05:24](https://youtu.be/rsSld8NycCU?t=324) potentially allowed to have a certain  
[0:05:25](https://youtu.be/rsSld8NycCU?t=325) number of downloads per studio category  
[0:05:28](https://youtu.be/rsSld8NycCU?t=328) and that number can change depending on  
[0:05:31](https://youtu.be/rsSld8NycCU?t=331) the studio arm negotiations  
[0:05:34](https://youtu.be/rsSld8NycCU?t=334) thirdly this one's interesting over the  
[0:05:38](https://youtu.be/rsSld8NycCU?t=338) course of a year you might only be able  
[0:05:40](https://youtu.be/rsSld8NycCU?t=340) to download or watch a certain piece of  
[0:05:43](https://youtu.be/rsSld8NycCU?t=343) content twice in the year so we need to  
[0:05:47](https://youtu.be/rsSld8NycCU?t=347) keep track over that year of what  
[0:05:49](https://youtu.be/rsSld8NycCU?t=349) content you've watched how many times  
[0:05:50](https://youtu.be/rsSld8NycCU?t=350) you've watched it and if there's any  
[0:05:51](https://youtu.be/rsSld8NycCU?t=351) restrictions in place potentially have  
[0:05:54](https://youtu.be/rsSld8NycCU?t=354) an a validation error that occurs on the  
[0:05:56](https://youtu.be/rsSld8NycCU?t=356) third time so we now have this life  
[0:05:59](https://youtu.be/rsSld8NycCU?t=359) cycle of a year which we need to keep  
[0:06:00](https://youtu.be/rsSld8NycCU?t=360) track of the customers state for a year  
[0:06:02](https://youtu.be/rsSld8NycCU?t=362) with a streaming example we didn't have  
[0:06:05](https://youtu.be/rsSld8NycCU?t=365) to keep track of the customers history  
[0:06:07](https://youtu.be/rsSld8NycCU?t=367) we're a stateless service all the  
[0:06:09](https://youtu.be/rsSld8NycCU?t=369) information we needed to process the  
[0:06:10](https://youtu.be/rsSld8NycCU?t=370) request was given to us in the request  
[0:06:12](https://youtu.be/rsSld8NycCU?t=372) now we need to actually have this state  
[0:06:15](https://youtu.be/rsSld8NycCU?t=375) recorded  
[0:06:16](https://youtu.be/rsSld8NycCU?t=376) we need a new stateful service the  
[0:06:18](https://youtu.be/rsSld8NycCU?t=378) licensed accounting service so let's  
[0:06:21](https://youtu.be/rsSld8NycCU?t=381) talk about some of the requirements that  
[0:06:22](https://youtu.be/rsSld8NycCU?t=382) we needed from this service first and  
[0:06:25](https://youtu.be/rsSld8NycCU?t=385) foremost for us was flexibility those  
[0:06:28](https://youtu.be/rsSld8NycCU?t=388) business requirements I just mentioned  
[0:06:30](https://youtu.be/rsSld8NycCU?t=390) when we first started designing this  
[0:06:32](https://youtu.be/rsSld8NycCU?t=392) project we did no idea what they were  
[0:06:34](https://youtu.be/rsSld8NycCU?t=394) gonna be there was still under  
[0:06:36](https://youtu.be/rsSld8NycCU?t=396) negotiation so all we know is we needed  
[0:06:39](https://youtu.be/rsSld8NycCU?t=399) to design something for use cases that  
[0:06:41](https://youtu.be/rsSld8NycCU?t=401) were coming and it needed to be flexible  
[0:06:44](https://youtu.be/rsSld8NycCU?t=404) to account for them  
[0:06:45](https://youtu.be/rsSld8NycCU?t=405) additionally even after release we still  
[0:06:48](https://youtu.be/rsSld8NycCU?t=408) had further business requirements that  
[0:06:49](https://youtu.be/rsSld8NycCU?t=409) were going to come out so this needs to  
[0:06:50](https://youtu.be/rsSld8NycCU?t=410) be an iterative flexible design secondly  
[0:06:55](https://youtu.be/rsSld8NycCU?t=415) it needs to be debuggable so as I said  
[0:06:59](https://youtu.be/rsSld8NycCU?t=419) we could have a year's worth of data we  
[0:07:00](https://youtu.be/rsSld8NycCU?t=420) could have a customer come in and said I  
[0:07:02](https://youtu.be/rsSld8NycCU?t=422) just got a validation error that said I  
[0:07:04](https://youtu.be/rsSld8NycCU?t=424) can't download this because I've hit my  
[0:07:06](https://youtu.be/rsSld8NycCU?t=426) download limit for something that  
[0:07:08](https://youtu.be/rsSld8NycCU?t=428) happened three months in the past we  
[0:07:11](https://youtu.be/rsSld8NycCU?t=431) need to be able to look back three  
[0:07:12](https://youtu.be/rsSld8NycCU?t=432) months and say at that point in time  
[0:07:14](https://youtu.be/rsSld8NycCU?t=434) what happened that caused this error and  
[0:07:16](https://youtu.be/rsSld8NycCU?t=436) the customers saying it's incorrect  
[0:07:17](https://youtu.be/rsSld8NycCU?t=437) where's the bug in our system that's  
[0:07:19](https://youtu.be/rsSld8NycCU?t=439) being countered by that three months ago  
[0:07:22](https://youtu.be/rsSld8NycCU?t=442) issue third needs to be reliable we're a  
[0:07:26](https://youtu.be/rsSld8NycCU?t=446) Tier one service if we go down  
[0:07:29](https://youtu.be/rsSld8NycCU?t=449) Netflix goes down let's not do that so  
[0:07:33](https://youtu.be/rsSld8NycCU?t=453) how can we make this reliable and fault  
[0:07:35](https://youtu.be/rsSld8NycCU?t=455) tolerant so that we're not going to  
[0:07:37](https://youtu.be/rsSld8NycCU?t=457) bring down the service fourth goes  
[0:07:42](https://youtu.be/rsSld8NycCU?t=462) without saying when Netflix we need to  
[0:07:44](https://youtu.be/rsSld8NycCU?t=464) be scalable we needed to scale from that  
[0:07:46](https://youtu.be/rsSld8NycCU?t=466) very first day to potentially tens of  
[0:07:48](https://youtu.be/rsSld8NycCU?t=468) millions of users around the world so  
[0:07:50](https://youtu.be/rsSld8NycCU?t=470) how do we account for that so let's deep  
[0:07:52](https://youtu.be/rsSld8NycCU?t=472) dive into each of these flexibility how  
[0:07:56](https://youtu.be/rsSld8NycCU?t=476) can we make our service and our domain  
[0:07:59](https://youtu.be/rsSld8NycCU?t=479) model flexible so when we first looked  
[0:08:03](https://youtu.be/rsSld8NycCU?t=483) at this we we definitely looked into  
[0:08:04](https://youtu.be/rsSld8NycCU?t=484) relational database models we have  
[0:08:06](https://youtu.be/rsSld8NycCU?t=486) experience on the team with using  
[0:08:08](https://youtu.be/rsSld8NycCU?t=488) relational databases but we wanted to  
[0:08:11](https://youtu.be/rsSld8NycCU?t=491) actually abstract away from the database  
[0:08:13](https://youtu.be/rsSld8NycCU?t=493) so we didn't have to directly interact  
[0:08:15](https://youtu.be/rsSld8NycCU?t=495) with the database to provide this  
[0:08:16](https://youtu.be/rsSld8NycCU?t=496) flexibility we didn't want to have to  
[0:08:18](https://youtu.be/rsSld8NycCU?t=498) have the migration tools and we didn't  
[0:08:20](https://youtu.be/rsSld8NycCU?t=500) want to have to add new columns etc to  
[0:08:22](https://youtu.be/rsSld8NycCU?t=502) bring in new changes to the domain model  
[0:08:24](https://youtu.be/rsSld8NycCU?t=504) for the new business requirements what  
[0:08:27](https://youtu.be/rsSld8NycCU?t=507) we wanted to do was have all of those  
[0:08:29](https://youtu.be/rsSld8NycCU?t=509) changes possible in the application  
[0:08:31](https://youtu.be/rsSld8NycCU?t=511) layer in our in our case the java  
[0:08:34](https://youtu.be/rsSld8NycCU?t=514) application layer so one way of doing  
[0:08:37](https://youtu.be/rsSld8NycCU?t=517) this was to use the document model in  
[0:08:38](https://youtu.be/rsSld8NycCU?t=518) the document model using versioning on  
[0:08:41](https://youtu.be/rsSld8NycCU?t=521) the object itself we could then  
[0:08:43](https://youtu.be/rsSld8NycCU?t=523) serialize the object start to the  
[0:08:45](https://youtu.be/rsSld8NycCU?t=525) database bring it back make changes as  
[0:08:47](https://youtu.be/rsSld8NycCU?t=527) needed create new objects as needed and  
[0:08:49](https://youtu.be/rsSld8NycCU?t=529) we get our flexibility right perfect  
[0:08:52](https://youtu.be/rsSld8NycCU?t=532) what are we losing debug ability every  
[0:08:57](https://youtu.be/rsSld8NycCU?t=537) time you make those changes  
[0:08:59](https://youtu.be/rsSld8NycCU?t=539) you're mutating the data and you've lost  
[0:09:01](https://youtu.be/rsSld8NycCU?t=541) the history of why that mutation  
[0:09:03](https://youtu.be/rsSld8NycCU?t=543) occurred you've lost the state change  
[0:09:06](https://youtu.be/rsSld8NycCU?t=546) event sourcing gives us that it gives us  
[0:09:09](https://youtu.be/rsSld8NycCU?t=549) an immutable transactional history of  
[0:09:12](https://youtu.be/rsSld8NycCU?t=552) every single state change that has  
[0:09:15](https://youtu.be/rsSld8NycCU?t=555) happened over the history of the  
[0:09:17](https://youtu.be/rsSld8NycCU?t=557) customer you can then take those events  
[0:09:20](https://youtu.be/rsSld8NycCU?t=560) and you can replay them and you can form  
[0:09:22](https://youtu.be/rsSld8NycCU?t=562) your domain model at the current state  
[0:09:25](https://youtu.be/rsSld8NycCU?t=565) and if you version the events and your  
[0:09:28](https://youtu.be/rsSld8NycCU?t=568) version the domain model you can make it  
[0:09:30](https://youtu.be/rsSld8NycCU?t=570) flexible you can add new fields for  
[0:09:32](https://youtu.be/rsSld8NycCU?t=572) ongoing events you can create new events  
[0:09:34](https://youtu.be/rsSld8NycCU?t=574) which are going to affect the current  
[0:09:36](https://youtu.be/rsSld8NycCU?t=576) domain model Roberts going to talk about  
[0:09:39](https://youtu.be/rsSld8NycCU?t=579) that they later sir  
[0:09:40](https://youtu.be/rsSld8NycCU?t=580) we will dive into that so we've got the  
[0:09:44](https://youtu.be/rsSld8NycCU?t=584) debug ability reliability we achieved  
[0:09:47](https://youtu.be/rsSld8NycCU?t=587) these through fullbacks which are  
[0:09:49](https://youtu.be/rsSld8NycCU?t=589) default customer behavior in the case of  
[0:09:50](https://youtu.be/rsSld8NycCU?t=590) outage I'm going to deep dive on this in  
[0:09:52](https://youtu.be/rsSld8NycCU?t=592) a bit as well and finally scalability  
[0:09:55](https://youtu.be/rsSld8NycCU?t=595) how did we achieve that so our service  
[0:09:58](https://youtu.be/rsSld8NycCU?t=598) was chief scalability through the use of  
[0:10:00](https://youtu.be/rsSld8NycCU?t=600) a tolling we called Scryer which is  
[0:10:02](https://youtu.be/rsSld8NycCU?t=602) predictive scaling and I will dive into  
[0:10:04](https://youtu.be/rsSld8NycCU?t=604) that a little bit later and then  
[0:10:05](https://youtu.be/rsSld8NycCU?t=605) inherently through the use of event  
[0:10:07](https://youtu.be/rsSld8NycCU?t=607) sourcing so I'm gonna hand over to  
[0:10:10](https://youtu.be/rsSld8NycCU?t=610) Robert now who's going to talk about how  
[0:10:11](https://youtu.be/rsSld8NycCU?t=611) we apply this as well as what it is all  
[0:10:17](https://youtu.be/rsSld8NycCU?t=617) right so before I deep dive into event  
[0:10:19](https://youtu.be/rsSld8NycCU?t=619) sourcing what I want to do is give a  
[0:10:20](https://youtu.be/rsSld8NycCU?t=620) general overview of the pattern for  
[0:10:22](https://youtu.be/rsSld8NycCU?t=622) those of you who aren't familiar with it  
[0:10:23](https://youtu.be/rsSld8NycCU?t=623) so if you think about the way we  
[0:10:25](https://youtu.be/rsSld8NycCU?t=625) traditionally work at the database we'll  
[0:10:27](https://youtu.be/rsSld8NycCU?t=627) send our query out to a data store or  
[0:10:29](https://youtu.be/rsSld8NycCU?t=629) get back some values what we'll do is  
[0:10:31](https://youtu.be/rsSld8NycCU?t=631) we'll write those values into the main  
[0:10:32](https://youtu.be/rsSld8NycCU?t=632) model and we'll use that for the rest of  
[0:10:34](https://youtu.be/rsSld8NycCU?t=634) our processor now with this the main  
[0:10:37](https://youtu.be/rsSld8NycCU?t=637) model represents is the current state of  
[0:10:38](https://youtu.be/rsSld8NycCU?t=638) your object at that moment of time you  
[0:10:40](https://youtu.be/rsSld8NycCU?t=640) did your query as people said what we  
[0:10:42](https://youtu.be/rsSld8NycCU?t=642) don't have are the events that got us to  
[0:10:44](https://youtu.be/rsSld8NycCU?t=644) this final life State that's just as  
[0:10:46](https://youtu.be/rsSld8NycCU?t=646) important in some situations so it comes  
[0:10:49](https://youtu.be/rsSld8NycCU?t=649) event sourcing I have a little visual  
[0:10:50](https://youtu.be/rsSld8NycCU?t=650) aid here to help me out to explain it in  
[0:10:52](https://youtu.be/rsSld8NycCU?t=652) a high-level what you actually see on  
[0:10:54](https://youtu.be/rsSld8NycCU?t=654) the screen here is some frosting in  
[0:10:56](https://youtu.be/rsSld8NycCU?t=656) different colors look at the leftmost  
[0:10:58](https://youtu.be/rsSld8NycCU?t=658) color and it's this cream color this is  
[0:11:00](https://youtu.be/rsSld8NycCU?t=660) an initial state of the frosting this is  
[0:11:02](https://youtu.be/rsSld8NycCU?t=662) how it gets delivered to the bakery and  
[0:11:04](https://youtu.be/rsSld8NycCU?t=664) you know cream is great and all but we  
[0:11:06](https://youtu.be/rsSld8NycCU?t=666) want to have fun with it so we want to  
[0:11:08](https://youtu.be/rsSld8NycCU?t=668) add some food dyes to make it red blue  
[0:11:10](https://youtu.be/rsSld8NycCU?t=670) whatever the customer wants  
[0:11:12](https://youtu.be/rsSld8NycCU?t=672) so my example we can think of the domain  
[0:11:14](https://youtu.be/rsSld8NycCU?t=674) model being a simple frosting object and  
[0:11:17](https://youtu.be/rsSld8NycCU?t=677) as one property as the color and the  
[0:11:20](https://youtu.be/rsSld8NycCU?t=680) goal that maker is to change that  
[0:11:22](https://youtu.be/rsSld8NycCU?t=682) property to the color that is dictated  
[0:11:24](https://youtu.be/rsSld8NycCU?t=684) by the order so in this example she has  
[0:11:27](https://youtu.be/rsSld8NycCU?t=687) an order calls for a purple cake so we  
[0:11:29](https://youtu.be/rsSld8NycCU?t=689) need to make this into a purple frosting  
[0:11:31](https://youtu.be/rsSld8NycCU?t=691) so she has a system that she works with  
[0:11:33](https://youtu.be/rsSld8NycCU?t=693) she goes up to a and she has two inputs  
[0:11:35](https://youtu.be/rsSld8NycCU?t=695) that she puts into it one being the  
[0:11:37](https://youtu.be/rsSld8NycCU?t=697) initial state of what she's working with  
[0:11:39](https://youtu.be/rsSld8NycCU?t=699) here we have the cream frosting the  
[0:11:42](https://youtu.be/rsSld8NycCU?t=702) second being a command that dictates  
[0:11:43](https://youtu.be/rsSld8NycCU?t=703) what do we want this frosting to be  
[0:11:45](https://youtu.be/rsSld8NycCU?t=705) after it's been processed so we feed  
[0:11:49](https://youtu.be/rsSld8NycCU?t=709) those two inputs to our command handler  
[0:11:50](https://youtu.be/rsSld8NycCU?t=710) which in this example is the system and  
[0:11:53](https://youtu.be/rsSld8NycCU?t=713) the command Heather knows how to change  
[0:11:55](https://youtu.be/rsSld8NycCU?t=715) the state of this domain model yeah so  
[0:11:58](https://youtu.be/rsSld8NycCU?t=718) given the make purple command it's smart  
[0:12:00](https://youtu.be/rsSld8NycCU?t=720) enough to know that in order to move  
[0:12:01](https://youtu.be/rsSld8NycCU?t=721) from this initial state of cream to  
[0:12:03](https://youtu.be/rsSld8NycCU?t=723) purple we need to do two things it's  
[0:12:05](https://youtu.be/rsSld8NycCU?t=725) gonna shoot out two events first you're  
[0:12:08](https://youtu.be/rsSld8NycCU?t=728) gonna add red then you're gonna add blue  
[0:12:11](https://youtu.be/rsSld8NycCU?t=731) these events are then given to the event  
[0:12:13](https://youtu.be/rsSld8NycCU?t=733) handler in our example the event handler  
[0:12:16](https://youtu.be/rsSld8NycCU?t=736) simply the Baker because she's the only  
[0:12:17](https://youtu.be/rsSld8NycCU?t=737) that's gonna be applying the events to  
[0:12:19](https://youtu.be/rsSld8NycCU?t=739) our domain model  
[0:12:19](https://youtu.be/rsSld8NycCU?t=739) she takes the first event as it saw her  
[0:12:22](https://youtu.be/rsSld8NycCU?t=742) current domain model and it's red now  
[0:12:25](https://youtu.be/rsSld8NycCU?t=745) this wasn't where we wanted to be we  
[0:12:26](https://youtu.be/rsSld8NycCU?t=746) wanted to make purple but we still have  
[0:12:28](https://youtu.be/rsSld8NycCU?t=748) one more event left so we're gonna apply  
[0:12:30](https://youtu.be/rsSld8NycCU?t=750) that on top of it and that gets us to  
[0:12:32](https://youtu.be/rsSld8NycCU?t=752) purple so what I'm going to do is I'm  
[0:12:36](https://youtu.be/rsSld8NycCU?t=756) going to change the terminology on you  
[0:12:37](https://youtu.be/rsSld8NycCU?t=757) I'm no longer going to say domain model  
[0:12:39](https://youtu.be/rsSld8NycCU?t=759) I'm going to start using the term  
[0:12:40](https://youtu.be/rsSld8NycCU?t=760) aggregate now an aggregate is a domain  
[0:12:43](https://youtu.be/rsSld8NycCU?t=763) model the difference between the two is  
[0:12:45](https://youtu.be/rsSld8NycCU?t=765) that you can decompose an aggregate to  
[0:12:48](https://youtu.be/rsSld8NycCU?t=768) the events that got you to this final  
[0:12:50](https://youtu.be/rsSld8NycCU?t=770) eye state so in this example this purple  
[0:12:52](https://youtu.be/rsSld8NycCU?t=772) frosting here can be decomposed to two  
[0:12:54](https://youtu.be/rsSld8NycCU?t=774) events the add red and the add blue  
[0:12:56](https://youtu.be/rsSld8NycCU?t=776) events if you always start with the same  
[0:12:58](https://youtu.be/rsSld8NycCU?t=778) initial state this cream color and apply  
[0:13:01](https://youtu.be/rsSld8NycCU?t=781) those two events on top of it you will  
[0:13:02](https://youtu.be/rsSld8NycCU?t=782) always get to this purple frosting  
[0:13:05](https://youtu.be/rsSld8NycCU?t=785) aggregate now going back to the commands  
[0:13:09](https://youtu.be/rsSld8NycCU?t=789) command is a part of the nomenclature  
[0:13:11](https://youtu.be/rsSld8NycCU?t=791) you'll see when you start researching  
[0:13:13](https://youtu.be/rsSld8NycCU?t=793) events or saying it's a little  
[0:13:14](https://youtu.be/rsSld8NycCU?t=794) unfortunate it's called a command  
[0:13:15](https://youtu.be/rsSld8NycCU?t=795) because the command kind of implies that  
[0:13:17](https://youtu.be/rsSld8NycCU?t=797) you have the authority to move from one  
[0:13:19](https://youtu.be/rsSld8NycCU?t=799) state to another but that's not the case  
[0:13:21](https://youtu.be/rsSld8NycCU?t=801) in event sourcing in a command it's  
[0:13:23](https://youtu.be/rsSld8NycCU?t=803) really more of a wish I wish to get to  
[0:13:24](https://youtu.be/rsSld8NycCU?t=804) this desire  
[0:13:26](https://youtu.be/rsSld8NycCU?t=806) here in this example you'll see that the  
[0:13:28](https://youtu.be/rsSld8NycCU?t=808) two inputs are my current state which is  
[0:13:30](https://youtu.be/rsSld8NycCU?t=810) purple frosting and I input a make red  
[0:13:33](https://youtu.be/rsSld8NycCU?t=813) commit command Haller notice well the  
[0:13:35](https://youtu.be/rsSld8NycCU?t=815) only way I can really make red out of  
[0:13:37](https://youtu.be/rsSld8NycCU?t=817) purple is by extracting the blue and we  
[0:13:39](https://youtu.be/rsSld8NycCU?t=819) know a baker doesn't have the ability to  
[0:13:41](https://youtu.be/rsSld8NycCU?t=821) extract colors only to add colors so the  
[0:13:43](https://youtu.be/rsSld8NycCU?t=823) command Haller is going to deny this  
[0:13:44](https://youtu.be/rsSld8NycCU?t=824) request so even though you give it a  
[0:13:46](https://youtu.be/rsSld8NycCU?t=826) command you need to be able to still  
[0:13:48](https://youtu.be/rsSld8NycCU?t=828) fell safely and this is a good example  
[0:13:50](https://youtu.be/rsSld8NycCU?t=830) of where the state doesn't change and no  
[0:13:54](https://youtu.be/rsSld8NycCU?t=834) new events are created now I'm going to  
[0:13:58](https://youtu.be/rsSld8NycCU?t=838) pull out a little bit here's a  
[0:13:59](https://youtu.be/rsSld8NycCU?t=839) high-level overview of the components  
[0:14:01](https://youtu.be/rsSld8NycCU?t=841) you had seen a typical event sourcing  
[0:14:03](https://youtu.be/rsSld8NycCU?t=843) application what I want to focus on in  
[0:14:05](https://youtu.be/rsSld8NycCU?t=845) the beginning are the two pairs in the  
[0:14:07](https://youtu.be/rsSld8NycCU?t=847) middle of the aggregate service and the  
[0:14:09](https://youtu.be/rsSld8NycCU?t=849) aggregate repository now these always  
[0:14:11](https://youtu.be/rsSld8NycCU?t=851) come in pairs for every aggregate that  
[0:14:14](https://youtu.be/rsSld8NycCU?t=854) you support in your system you're gonna  
[0:14:16](https://youtu.be/rsSld8NycCU?t=856) have a service in a repository sown in a  
[0:14:18](https://youtu.be/rsSld8NycCU?t=858) grits mean in pairs of these I also  
[0:14:21](https://youtu.be/rsSld8NycCU?t=861) notice that for every component it's  
[0:14:23](https://youtu.be/rsSld8NycCU?t=863) directly dependent on the one that's to  
[0:14:24](https://youtu.be/rsSld8NycCU?t=864) the right of it  
[0:14:25](https://youtu.be/rsSld8NycCU?t=865) so what we're going to do is we're going  
[0:14:27](https://youtu.be/rsSld8NycCU?t=867) to start with the event store and then  
[0:14:29](https://youtu.be/rsSld8NycCU?t=869) we're going to work our way left to kind  
[0:14:30](https://youtu.be/rsSld8NycCU?t=870) of give a better overview of how all of  
[0:14:32](https://youtu.be/rsSld8NycCU?t=872) these play together and what they're  
[0:14:33](https://youtu.be/rsSld8NycCU?t=873) individual rows are in a vent sourcing  
[0:14:37](https://youtu.be/rsSld8NycCU?t=877) so let's start with the event story this  
[0:14:40](https://youtu.be/rsSld8NycCU?t=880) is your database the implementation is  
[0:14:42](https://youtu.be/rsSld8NycCU?t=882) up to you  
[0:14:43](https://youtu.be/rsSld8NycCU?t=883) you'll be whatever you want just depends  
[0:14:45](https://youtu.be/rsSld8NycCU?t=885) on what your business requirements are  
[0:14:46](https://youtu.be/rsSld8NycCU?t=886) do you prefer scalability deeper  
[0:14:49](https://youtu.be/rsSld8NycCU?t=889) consistency there's just a lot of  
[0:14:50](https://youtu.be/rsSld8NycCU?t=890) factors you have to wait until you  
[0:14:52](https://youtu.be/rsSld8NycCU?t=892) eventually get to the implementation  
[0:14:53](https://youtu.be/rsSld8NycCU?t=893) that you're going to run with but at the  
[0:14:55](https://youtu.be/rsSld8NycCU?t=895) end of the day the event source  
[0:14:57](https://youtu.be/rsSld8NycCU?t=897) basically you're just going to take a  
[0:14:58](https://youtu.be/rsSld8NycCU?t=898) row ID and send you back a list of  
[0:15:00](https://youtu.be/rsSld8NycCU?t=900) events and these events are what you're  
[0:15:02](https://youtu.be/rsSld8NycCU?t=902) going to replay on top of an aggregate  
[0:15:04](https://youtu.be/rsSld8NycCU?t=904) to move its state incrementally until  
[0:15:06](https://youtu.be/rsSld8NycCU?t=906) you get to that last finalized State one  
[0:15:10](https://youtu.be/rsSld8NycCU?t=910) thing I do want to know is all events on  
[0:15:12](https://youtu.be/rsSld8NycCU?t=912) a single row do not necessarily apply to  
[0:15:14](https://youtu.be/rsSld8NycCU?t=914) just one aggregate you're gonna have the  
[0:15:17](https://youtu.be/rsSld8NycCU?t=917) events applied to multiple aggregates  
[0:15:19](https://youtu.be/rsSld8NycCU?t=919) and we do that by signing it an  
[0:15:21](https://youtu.be/rsSld8NycCU?t=921) aggregate ID so for every distinct  
[0:15:23](https://youtu.be/rsSld8NycCU?t=923) aggregate ID you have in your list of  
[0:15:25](https://youtu.be/rsSld8NycCU?t=925) events there's gonna be that many  
[0:15:26](https://youtu.be/rsSld8NycCU?t=926) aggregates and here's an example of to  
[0:15:29](https://youtu.be/rsSld8NycCU?t=929) aggregate IDs a great idea one being the  
[0:15:32](https://youtu.be/rsSld8NycCU?t=932) blue color an aggregate ID to being a  
[0:15:34](https://youtu.be/rsSld8NycCU?t=934) pink color when we process these this is  
[0:15:37](https://youtu.be/rsSld8NycCU?t=937) going to result in two two aggregates  
[0:15:38](https://youtu.be/rsSld8NycCU?t=938) for us  
[0:15:39](https://youtu.be/rsSld8NycCU?t=939) process with now something has to query  
[0:15:43](https://youtu.be/rsSld8NycCU?t=943) the event store to get this data that's  
[0:15:46](https://youtu.be/rsSld8NycCU?t=946) where the repository comes in the  
[0:15:48](https://youtu.be/rsSld8NycCU?t=948) repository takes queries in your domain  
[0:15:50](https://youtu.be/rsSld8NycCU?t=950) jargon and translates it to the  
[0:15:52](https://youtu.be/rsSld8NycCU?t=952) appropriate statement to send out to  
[0:15:54](https://youtu.be/rsSld8NycCU?t=954) your event store so whether it's SQL or  
[0:15:56](https://youtu.be/rsSld8NycCU?t=956) CQ o is going to go ahead and just  
[0:15:59](https://youtu.be/rsSld8NycCU?t=959) translate it and say hey give me all the  
[0:16:03](https://youtu.be/rsSld8NycCU?t=963) events that I'm asking for so in this  
[0:16:04](https://youtu.be/rsSld8NycCU?t=964) example the repository is asking for all  
[0:16:07](https://youtu.be/rsSld8NycCU?t=967) the events in a highlighted row the  
[0:16:10](https://youtu.be/rsSld8NycCU?t=970) event stores happy to oblige and will  
[0:16:12](https://youtu.be/rsSld8NycCU?t=972) return the events we just zoomed in on  
[0:16:15](https://youtu.be/rsSld8NycCU?t=975) this will give the repository of the  
[0:16:17](https://youtu.be/rsSld8NycCU?t=977) events in memory and it's going to start  
[0:16:19](https://youtu.be/rsSld8NycCU?t=979) buckets heisting them by their aggregate  
[0:16:20](https://youtu.be/rsSld8NycCU?t=980) ID so as I mentioned before this  
[0:16:23](https://youtu.be/rsSld8NycCU?t=983) actually maps to two aggregates so the  
[0:16:25](https://youtu.be/rsSld8NycCU?t=985) repository is going to start placing  
[0:16:26](https://youtu.be/rsSld8NycCU?t=986) them into their buckets we start with e1  
[0:16:29](https://youtu.be/rsSld8NycCU?t=989) which has an a great idea 1e2 has the  
[0:16:33](https://youtu.be/rsSld8NycCU?t=993) same aggregate ID so we're gonna place  
[0:16:35](https://youtu.be/rsSld8NycCU?t=995) it in that bucket  
[0:16:36](https://youtu.be/rsSld8NycCU?t=996) now we 3 has its own a different  
[0:16:39](https://youtu.be/rsSld8NycCU?t=999) aggregate ID so we create a new bucket  
[0:16:41](https://youtu.be/rsSld8NycCU?t=1001) and we place it there now we have no  
[0:16:44](https://youtu.be/rsSld8NycCU?t=1004) more distinct that great ID so we're  
[0:16:45](https://youtu.be/rsSld8NycCU?t=1005) just going to let the repository finish  
[0:16:46](https://youtu.be/rsSld8NycCU?t=1006) up bucket eyes in these events once  
[0:16:51](https://youtu.be/rsSld8NycCU?t=1011) they're placed in their appropriate  
[0:16:52](https://youtu.be/rsSld8NycCU?t=1012) buckets we create two uninitialized  
[0:16:55](https://youtu.be/rsSld8NycCU?t=1015) aggregates and we're going to start  
[0:16:57](https://youtu.be/rsSld8NycCU?t=1017) applying these events on top of it and  
[0:17:00](https://youtu.be/rsSld8NycCU?t=1020) for every event that we play on top of  
[0:17:02](https://youtu.be/rsSld8NycCU?t=1022) it it moves the state forward in time  
[0:17:04](https://youtu.be/rsSld8NycCU?t=1024) until we stink exhausted all our events  
[0:17:07](https://youtu.be/rsSld8NycCU?t=1027) and we get to the final eye state of our  
[0:17:09](https://youtu.be/rsSld8NycCU?t=1029) aggregates I here a repository also has  
[0:17:13](https://youtu.be/rsSld8NycCU?t=1033) the ability to update the state of an  
[0:17:15](https://youtu.be/rsSld8NycCU?t=1035) aggregate and it does that by accepting  
[0:17:17](https://youtu.be/rsSld8NycCU?t=1037) two inputs your current aggregate and  
[0:17:19](https://youtu.be/rsSld8NycCU?t=1039) the command you wish to apply to it  
[0:17:21](https://youtu.be/rsSld8NycCU?t=1041) command haller knows in order to get to  
[0:17:24](https://youtu.be/rsSld8NycCU?t=1044) our desired state we need to apply these  
[0:17:26](https://youtu.be/rsSld8NycCU?t=1046) events to it so in this generic example  
[0:17:29](https://youtu.be/rsSld8NycCU?t=1049) the command handler gave us two events  
[0:17:31](https://youtu.be/rsSld8NycCU?t=1051) it says in order to fulfill your command  
[0:17:32](https://youtu.be/rsSld8NycCU?t=1052) just run these on top of your current  
[0:17:34](https://youtu.be/rsSld8NycCU?t=1054) state repository we'll add those events  
[0:17:39](https://youtu.be/rsSld8NycCU?t=1059) to our aggregate that's in memory and  
[0:17:44](https://youtu.be/rsSld8NycCU?t=1064) now our in-memory aggregate is updated  
[0:17:46](https://youtu.be/rsSld8NycCU?t=1066) so anybody who has a reference to this  
[0:17:47](https://youtu.be/rsSld8NycCU?t=1067) now has the new values it'll also send  
[0:17:51](https://youtu.be/rsSld8NycCU?t=1071) the events out to datastore  
[0:17:53](https://youtu.be/rsSld8NycCU?t=1073) so here we're telling the event store to  
[0:17:55](https://youtu.be/rsSld8NycCU?t=1075) append these two events to the row ID  
[0:17:57](https://youtu.be/rsSld8NycCU?t=1077) that we had queried earlier so now when  
[0:17:59](https://youtu.be/rsSld8NycCU?t=1079) we zoom in on it  
[0:17:59](https://youtu.be/rsSld8NycCU?t=1079) you'll see that I 8 and 9 are now at the  
[0:18:02](https://youtu.be/rsSld8NycCU?t=1082) end of this list  
[0:18:03](https://youtu.be/rsSld8NycCU?t=1083) so when we go back and we query for this  
[0:18:05](https://youtu.be/rsSld8NycCU?t=1085) row ID we're going to get that new state  
[0:18:07](https://youtu.be/rsSld8NycCU?t=1087) that we changed to because of the  
[0:18:09](https://youtu.be/rsSld8NycCU?t=1089) command and finally we have the  
[0:18:13](https://youtu.be/rsSld8NycCU?t=1093) aggregate service this is the public  
[0:18:15](https://youtu.be/rsSld8NycCU?t=1095) facing API that your customers are going  
[0:18:17](https://youtu.be/rsSld8NycCU?t=1097) to work with so when you package your  
[0:18:18](https://youtu.be/rsSld8NycCU?t=1098) library and you ship it out to them this  
[0:18:20](https://youtu.be/rsSld8NycCU?t=1100) is going to be the layer they're going  
[0:18:21](https://youtu.be/rsSld8NycCU?t=1101) to interact with the aggregate services  
[0:18:24](https://youtu.be/rsSld8NycCU?t=1104) business aware it knows what your  
[0:18:25](https://youtu.be/rsSld8NycCU?t=1105) business rules are so we can reject the  
[0:18:27](https://youtu.be/rsSld8NycCU?t=1107) requests of your customers trying to do  
[0:18:29](https://youtu.be/rsSld8NycCU?t=1109) something they shouldn't be doing in our  
[0:18:31](https://youtu.be/rsSld8NycCU?t=1111) example subscription plans or the number  
[0:18:33](https://youtu.be/rsSld8NycCU?t=1113) of times you can download a certain  
[0:18:35](https://youtu.be/rsSld8NycCU?t=1115) title similar like the repository or a  
[0:18:38](https://youtu.be/rsSld8NycCU?t=1118) repository can reject a request because  
[0:18:41](https://youtu.be/rsSld8NycCU?t=1121) of an invalid state change service has  
[0:18:43](https://youtu.be/rsSld8NycCU?t=1123) the same capability but for a different  
[0:18:44](https://youtu.be/rsSld8NycCU?t=1124) reason  
[0:18:45](https://youtu.be/rsSld8NycCU?t=1125) just more business validation in this  
[0:18:47](https://youtu.be/rsSld8NycCU?t=1127) example we ask the repository for all  
[0:18:50](https://youtu.be/rsSld8NycCU?t=1130) the aggregates for a specific customer  
[0:18:51](https://youtu.be/rsSld8NycCU?t=1131) and a repository respondent with 2  
[0:18:53](https://youtu.be/rsSld8NycCU?t=1133) aggregates at this point the service can  
[0:18:55](https://youtu.be/rsSld8NycCU?t=1135) just think of them as the main models  
[0:18:57](https://youtu.be/rsSld8NycCU?t=1137) because it doesn't necessarily care  
[0:18:58](https://youtu.be/rsSld8NycCU?t=1138) about the events that got it there so  
[0:19:00](https://youtu.be/rsSld8NycCU?t=1140) it's going to look at the size of the  
[0:19:01](https://youtu.be/rsSld8NycCU?t=1141) list I came back let's go look at the  
[0:19:03](https://youtu.be/rsSld8NycCU?t=1143) values of the aggregates and it's going  
[0:19:04](https://youtu.be/rsSld8NycCU?t=1144) to make business decisions based off  
[0:19:06](https://youtu.be/rsSld8NycCU?t=1146) that all right so now I'm going to talk  
[0:19:10](https://youtu.be/rsSld8NycCU?t=1150) about to our grits that we actually use  
[0:19:12](https://youtu.be/rsSld8NycCU?t=1152) in our system today we have a licensed  
[0:19:14](https://youtu.be/rsSld8NycCU?t=1154) aggregate we have a downloaded aggregate  
[0:19:16](https://youtu.be/rsSld8NycCU?t=1156) license I recreate those any time we  
[0:19:19](https://youtu.be/rsSld8NycCU?t=1159) hand your device the license we need to  
[0:19:20](https://youtu.be/rsSld8NycCU?t=1160) keep track of it as Pippo said before we  
[0:19:23](https://youtu.be/rsSld8NycCU?t=1163) used to just hand out licenses and  
[0:19:24](https://youtu.be/rsSld8NycCU?t=1164) forget about it but now we want to know  
[0:19:26](https://youtu.be/rsSld8NycCU?t=1166) exactly how many do you have at any time  
[0:19:29](https://youtu.be/rsSld8NycCU?t=1169) because that's important for our  
[0:19:30](https://youtu.be/rsSld8NycCU?t=1170) business validation so well create the  
[0:19:32](https://youtu.be/rsSld8NycCU?t=1172) license I agree when your device is done  
[0:19:35](https://youtu.be/rsSld8NycCU?t=1175) downloading it will notify us with an  
[0:19:37](https://youtu.be/rsSld8NycCU?t=1177) event when we get that event will create  
[0:19:39](https://youtu.be/rsSld8NycCU?t=1179) a downloaded aggregate and we'll save  
[0:19:41](https://youtu.be/rsSld8NycCU?t=1181) that off this allows us to be able to  
[0:19:43](https://youtu.be/rsSld8NycCU?t=1183) reject a request if a specific title has  
[0:19:45](https://youtu.be/rsSld8NycCU?t=1185) been downloaded too many times  
[0:19:49](https://youtu.be/rsSld8NycCU?t=1189) all right so walking through the example  
[0:19:51](https://youtu.be/rsSld8NycCU?t=1191) here when you hit download on your  
[0:19:52](https://youtu.be/rsSld8NycCU?t=1192) device it's going to need a license in  
[0:19:54](https://youtu.be/rsSld8NycCU?t=1194) order to play that media so it's going  
[0:19:56](https://youtu.be/rsSld8NycCU?t=1196) to hit our car license end point it's  
[0:19:58](https://youtu.be/rsSld8NycCU?t=1198) going to afford that request to our  
[0:19:59](https://youtu.be/rsSld8NycCU?t=1199) license service it's gonna ask the  
[0:20:01](https://youtu.be/rsSld8NycCU?t=1201) license service for a license and if  
[0:20:02](https://youtu.be/rsSld8NycCU?t=1202) it's successful it's going to return  
[0:20:04](https://youtu.be/rsSld8NycCU?t=1204) it's going to respond back with a  
[0:20:05](https://youtu.be/rsSld8NycCU?t=1205) license to get  
[0:20:06](https://youtu.be/rsSld8NycCU?t=1206) device in this example we have our  
[0:20:09](https://youtu.be/rsSld8NycCU?t=1209) customer being Baily and she wants to  
[0:20:11](https://youtu.be/rsSld8NycCU?t=1211) download Glo Season one Episode one not  
[0:20:14](https://youtu.be/rsSld8NycCU?t=1214) a licensed service as I said before it's  
[0:20:15](https://youtu.be/rsSld8NycCU?t=1215) business aware and it knows there's only  
[0:20:17](https://youtu.be/rsSld8NycCU?t=1217) so many times you can download this  
[0:20:19](https://youtu.be/rsSld8NycCU?t=1219) title oh it's actually gonna do it's  
[0:20:21](https://youtu.be/rsSld8NycCU?t=1221) gonna defer that to the downloaded  
[0:20:24](https://youtu.be/rsSld8NycCU?t=1224) service it's gonna ask the downloaded  
[0:20:25](https://youtu.be/rsSld8NycCU?t=1225) service is Bailey allowed to download  
[0:20:27](https://youtu.be/rsSld8NycCU?t=1227) this title again downloaded service exit  
[0:20:30](https://youtu.be/rsSld8NycCU?t=1230) from there  
[0:20:31](https://youtu.be/rsSld8NycCU?t=1231) that's a repository for this customer  
[0:20:34](https://youtu.be/rsSld8NycCU?t=1234) and tadow combination give me all the  
[0:20:36](https://youtu.be/rsSld8NycCU?t=1236) aggregates that exist in our event store  
[0:20:38](https://youtu.be/rsSld8NycCU?t=1238) and only do it for the past year because  
[0:20:41](https://youtu.be/rsSld8NycCU?t=1241) our limits are usually based download  
[0:20:44](https://youtu.be/rsSld8NycCU?t=1244) repository goes does its thing returns  
[0:20:46](https://youtu.be/rsSld8NycCU?t=1246) back to downloaded aggregates each  
[0:20:48](https://youtu.be/rsSld8NycCU?t=1248) aggregate represents a time that Bailey  
[0:20:50](https://youtu.be/rsSld8NycCU?t=1250) downloaded this specific title so we see  
[0:20:52](https://youtu.be/rsSld8NycCU?t=1252) that she downloaded it February 15th and  
[0:20:55](https://youtu.be/rsSld8NycCU?t=1255) she also downloaded it May 25th the  
[0:21:00](https://youtu.be/rsSld8NycCU?t=1260) downloaded service is now going to do  
[0:21:02](https://youtu.be/rsSld8NycCU?t=1262) the business validation it knows that  
[0:21:04](https://youtu.be/rsSld8NycCU?t=1264) the yearly limit is 3 for this title and  
[0:21:07](https://youtu.be/rsSld8NycCU?t=1267) it's going to look at the size of the  
[0:21:08](https://youtu.be/rsSld8NycCU?t=1268) list that came back which is 2 so now  
[0:21:11](https://youtu.be/rsSld8NycCU?t=1271) we're going to respond back true to our  
[0:21:12](https://youtu.be/rsSld8NycCU?t=1272) license service we're Intel a licensed  
[0:21:14](https://youtu.be/rsSld8NycCU?t=1274) service you have to go ahead to give her  
[0:21:16](https://youtu.be/rsSld8NycCU?t=1276) a license she has one more slot left  
[0:21:18](https://youtu.be/rsSld8NycCU?t=1278) available licensed services then going  
[0:21:21](https://youtu.be/rsSld8NycCU?t=1281) to create an uninitialized license i  
[0:21:23](https://youtu.be/rsSld8NycCU?t=1283) argue because a new license means a new  
[0:21:25](https://youtu.be/rsSld8NycCU?t=1285) license aggregate and it's going to also  
[0:21:27](https://youtu.be/rsSld8NycCU?t=1287) hand the license repository a command to  
[0:21:29](https://youtu.be/rsSld8NycCU?t=1289) get it to an initialized state and the  
[0:21:32](https://youtu.be/rsSld8NycCU?t=1292) commands going to create it's going to  
[0:21:33](https://youtu.be/rsSld8NycCU?t=1293) have some properties of what we want to  
[0:21:35](https://youtu.be/rsSld8NycCU?t=1295) apply on top of the guy aggregate  
[0:21:39](https://youtu.be/rsSld8NycCU?t=1299) repository takes the two inputs passes  
[0:21:43](https://youtu.be/rsSld8NycCU?t=1303) it on to the command handler command  
[0:21:44](https://youtu.be/rsSld8NycCU?t=1304) heller knows what events need to happen  
[0:21:46](https://youtu.be/rsSld8NycCU?t=1306) in order to get to this initialized  
[0:21:48](https://youtu.be/rsSld8NycCU?t=1308) state in this case it creates a license  
[0:21:50](https://youtu.be/rsSld8NycCU?t=1310) created event and it has a customer ID  
[0:21:53](https://youtu.be/rsSld8NycCU?t=1313) set with the title that she downloaded  
[0:21:54](https://youtu.be/rsSld8NycCU?t=1314) and when she downloaded it this event is  
[0:21:57](https://youtu.be/rsSld8NycCU?t=1317) then handed to the event handler along  
[0:21:59](https://youtu.be/rsSld8NycCU?t=1319) with our uninitialized aggregate event  
[0:22:01](https://youtu.be/rsSld8NycCU?t=1321) handler it's going to replay it on top  
[0:22:03](https://youtu.be/rsSld8NycCU?t=1323) of the aggregate and now we have an  
[0:22:05](https://youtu.be/rsSld8NycCU?t=1325) initialized aggregate tells us the  
[0:22:06](https://youtu.be/rsSld8NycCU?t=1326) customer ID the title when any expires  
[0:22:09](https://youtu.be/rsSld8NycCU?t=1329) we typically have a 30-day window of how  
[0:22:12](https://youtu.be/rsSld8NycCU?t=1332) long you are you able to use a license  
[0:22:14](https://youtu.be/rsSld8NycCU?t=1334) so here we have July 27th that's the  
[0:22:16](https://youtu.be/rsSld8NycCU?t=1336) expiration date and whether or not  
[0:22:17](https://youtu.be/rsSld8NycCU?t=1337) released basically did you delete it off  
[0:22:19](https://youtu.be/rsSld8NycCU?t=1339) your device which means it's  
[0:22:20](https://youtu.be/rsSld8NycCU?t=1340) longer active it's false because we're  
[0:22:22](https://youtu.be/rsSld8NycCU?t=1342) about to send this to you and you're  
[0:22:23](https://youtu.be/rsSld8NycCU?t=1343) gonna use it as soon as you get it and  
[0:22:27](https://youtu.be/rsSld8NycCU?t=1347) then finally the license repository will  
[0:22:29](https://youtu.be/rsSld8NycCU?t=1349) save this event to the event story so  
[0:22:31](https://youtu.be/rsSld8NycCU?t=1351) the next time we want to update this  
[0:22:34](https://youtu.be/rsSld8NycCU?t=1354) license I regret we will a so events or  
[0:22:36](https://youtu.be/rsSld8NycCU?t=1356) for all the events that's associated  
[0:22:38](https://youtu.be/rsSld8NycCU?t=1358) with it in this case there's only one so  
[0:22:40](https://youtu.be/rsSld8NycCU?t=1360) now we know that we would have a license  
[0:22:42](https://youtu.be/rsSld8NycCU?t=1362) area that is still active when we quarry  
[0:22:45](https://youtu.be/rsSld8NycCU?t=1365) for it and then finally the license  
[0:22:48](https://youtu.be/rsSld8NycCU?t=1368) repository tell us a license service  
[0:22:50](https://youtu.be/rsSld8NycCU?t=1370) that the aggregate was created  
[0:22:52](https://youtu.be/rsSld8NycCU?t=1372) successfully the license service then  
[0:22:54](https://youtu.be/rsSld8NycCU?t=1374) goes out to our DRM servers gets a  
[0:22:56](https://youtu.be/rsSld8NycCU?t=1376) license and then passes that back to the  
[0:22:58](https://youtu.be/rsSld8NycCU?t=1378) device so what device has this license  
[0:23:01](https://youtu.be/rsSld8NycCU?t=1381) we have to work keeping track of it now  
[0:23:05](https://youtu.be/rsSld8NycCU?t=1385) quickly going back to the is allowed  
[0:23:07](https://youtu.be/rsSld8NycCU?t=1387) question we could have done this with  
[0:23:09](https://youtu.be/rsSld8NycCU?t=1389) just the license aggregate we didn't  
[0:23:11](https://youtu.be/rsSld8NycCU?t=1391) need to have a downloaded aggregate in  
[0:23:13](https://youtu.be/rsSld8NycCU?t=1393) order to do that the license service  
[0:23:14](https://youtu.be/rsSld8NycCU?t=1394) would ask the license repository give me  
[0:23:16](https://youtu.be/rsSld8NycCU?t=1396) all the licenses that Bailey has had in  
[0:23:19](https://youtu.be/rsSld8NycCU?t=1399) the past year and with whatever I get  
[0:23:22](https://youtu.be/rsSld8NycCU?t=1402) back I'm going to filter out that's how  
[0:23:24](https://youtu.be/rsSld8NycCU?t=1404) the licenses I have to do with titles  
[0:23:26](https://youtu.be/rsSld8NycCU?t=1406) that I'm not interested in right now so  
[0:23:28](https://youtu.be/rsSld8NycCU?t=1408) as you can imagine the vast majority of  
[0:23:30](https://youtu.be/rsSld8NycCU?t=1410) these licenses are going to be filtered  
[0:23:31](https://youtu.be/rsSld8NycCU?t=1411) out and then whatever I have left I'm  
[0:23:33](https://youtu.be/rsSld8NycCU?t=1413) going to use that as my sighs I don't  
[0:23:34](https://youtu.be/rsSld8NycCU?t=1414) know compare it to my yearly limits now  
[0:23:37](https://youtu.be/rsSld8NycCU?t=1417) this is a very expensive operation think  
[0:23:39](https://youtu.be/rsSld8NycCU?t=1419) about what this implies you have to read  
[0:23:41](https://youtu.be/rsSld8NycCU?t=1421) every event that Bailey has ever done  
[0:23:43](https://youtu.be/rsSld8NycCU?t=1423) within the last year map them to license  
[0:23:46](https://youtu.be/rsSld8NycCU?t=1426) aggregates send them to the service and  
[0:23:48](https://youtu.be/rsSld8NycCU?t=1428) the service is going to probably just  
[0:23:50](https://youtu.be/rsSld8NycCU?t=1430) discard about 90 to 95 percent of them  
[0:23:52](https://youtu.be/rsSld8NycCU?t=1432) just to get to this final answer  
[0:23:53](https://youtu.be/rsSld8NycCU?t=1433) so what we did was we created this  
[0:23:55](https://youtu.be/rsSld8NycCU?t=1435) downloaded aggregate to quickly answer  
[0:23:57](https://youtu.be/rsSld8NycCU?t=1437) this new query we needed to support so  
[0:24:00](https://youtu.be/rsSld8NycCU?t=1440) for anybody who's familiar with  
[0:24:02](https://youtu.be/rsSld8NycCU?t=1442) denormalization  
[0:24:03](https://youtu.be/rsSld8NycCU?t=1443) this should be very familiar to you  
[0:24:05](https://youtu.be/rsSld8NycCU?t=1445) because it's pretty much the same thing  
[0:24:06](https://youtu.be/rsSld8NycCU?t=1446) if we have a new query that you need to  
[0:24:08](https://youtu.be/rsSld8NycCU?t=1448) support look at your aggregates can you  
[0:24:10](https://youtu.be/rsSld8NycCU?t=1450) support it if you can can you do it  
[0:24:13](https://youtu.be/rsSld8NycCU?t=1453) efficiently if not go ahead create a new  
[0:24:15](https://youtu.be/rsSld8NycCU?t=1455) aggregate just to support that query  
[0:24:17](https://youtu.be/rsSld8NycCU?t=1457) it's okay we've done that before and it  
[0:24:19](https://youtu.be/rsSld8NycCU?t=1459) works great alright so now I'm going to  
[0:24:22](https://youtu.be/rsSld8NycCU?t=1462) deep dive into our of our events store  
[0:24:25](https://youtu.be/rsSld8NycCU?t=1465) implementation we ended up going with  
[0:24:27](https://youtu.be/rsSld8NycCU?t=1467) Cassandra give a quick overview on  
[0:24:29](https://youtu.be/rsSld8NycCU?t=1469) Cassandra you have three different types  
[0:24:30](https://youtu.be/rsSld8NycCU?t=1470) of columns in Cassandra first being the  
[0:24:33](https://youtu.be/rsSld8NycCU?t=1473) partition key  
[0:24:34](https://youtu.be/rsSld8NycCU?t=1474) hache of these values is going to tell  
[0:24:35](https://youtu.be/rsSld8NycCU?t=1475) you which node in your cluster your data  
[0:24:37](https://youtu.be/rsSld8NycCU?t=1477) is going to live on next because the  
[0:24:40](https://youtu.be/rsSld8NycCU?t=1480) clustering columns because many rows can  
[0:24:43](https://youtu.be/rsSld8NycCU?t=1483) map to the same partition key we want to  
[0:24:45](https://youtu.be/rsSld8NycCU?t=1485) be able to group them by a value so  
[0:24:47](https://youtu.be/rsSld8NycCU?t=1487) we're going to group them by the first  
[0:24:49](https://youtu.be/rsSld8NycCU?t=1489) clustering column and then within that  
[0:24:51](https://youtu.be/rsSld8NycCU?t=1491) group we're going to group it by the  
[0:24:52](https://youtu.be/rsSld8NycCU?t=1492) second clustering column and so on and  
[0:24:54](https://youtu.be/rsSld8NycCU?t=1494) so on just depends how many clustering  
[0:24:56](https://youtu.be/rsSld8NycCU?t=1496) columns you have and then finally we  
[0:24:58](https://youtu.be/rsSld8NycCU?t=1498) have plain old columns you can't search  
[0:25:00](https://youtu.be/rsSld8NycCU?t=1500) against this data but it's the data  
[0:25:02](https://youtu.be/rsSld8NycCU?t=1502) you're trying to get to well when you  
[0:25:04](https://youtu.be/rsSld8NycCU?t=1504) finally locate the row and you read it  
[0:25:05](https://youtu.be/rsSld8NycCU?t=1505) in so this is a schema of what we're  
[0:25:09](https://youtu.be/rsSld8NycCU?t=1509) using today for event sourcing table row  
[0:25:13](https://youtu.be/rsSld8NycCU?t=1513) ID it's up to the license aggregates you  
[0:25:15](https://youtu.be/rsSld8NycCU?t=1515) create a row ID each aggregate I'm sorry  
[0:25:19](https://youtu.be/rsSld8NycCU?t=1519) each aggregate can independently choose  
[0:25:22](https://youtu.be/rsSld8NycCU?t=1522) how the rows are going to be stored into  
[0:25:24](https://youtu.be/rsSld8NycCU?t=1524) the event store typically the row ID is  
[0:25:28](https://youtu.be/rsSld8NycCU?t=1528) simply the customer ID appendant with  
[0:25:30](https://youtu.be/rsSld8NycCU?t=1530) the aggregate name now because it's that  
[0:25:33](https://youtu.be/rsSld8NycCU?t=1533) simple you can imagine lots of rows are  
[0:25:35](https://youtu.be/rsSld8NycCU?t=1535) going to map to this row ID so we want  
[0:25:37](https://youtu.be/rsSld8NycCU?t=1537) our first clustering column to be the  
[0:25:39](https://youtu.be/rsSld8NycCU?t=1539) aggregate ID we want to collate  
[0:25:40](https://youtu.be/rsSld8NycCU?t=1540) co-locate all the events with the same  
[0:25:43](https://youtu.be/rsSld8NycCU?t=1543) an aggregate ID together and then within  
[0:25:45](https://youtu.be/rsSld8NycCU?t=1545) that grouping we want to sort it by the  
[0:25:47](https://youtu.be/rsSld8NycCU?t=1547) event time this is going to put our  
[0:25:50](https://youtu.be/rsSld8NycCU?t=1550) events in a natural sequence that when  
[0:25:52](https://youtu.be/rsSld8NycCU?t=1552) we get it back in our query  
[0:25:54](https://youtu.be/rsSld8NycCU?t=1554) we're going to play it in the order we  
[0:25:55](https://youtu.be/rsSld8NycCU?t=1555) got it on top of our aggregate and then  
[0:25:58](https://youtu.be/rsSld8NycCU?t=1558) finally we have the event data which  
[0:26:00](https://youtu.be/rsSld8NycCU?t=1560) just has our serialize data an event  
[0:26:02](https://youtu.be/rsSld8NycCU?t=1562) mapper which will tell us what  
[0:26:03](https://youtu.be/rsSld8NycCU?t=1563) serializer to use to deserialize the  
[0:26:06](https://youtu.be/rsSld8NycCU?t=1566) data well I'll talk about cryo this is  
[0:26:10](https://youtu.be/rsSld8NycCU?t=1570) the civilization framework we ended up  
[0:26:12](https://youtu.be/rsSld8NycCU?t=1572) using in our system it's open source I'm  
[0:26:15](https://youtu.be/rsSld8NycCU?t=1575) grabbing the github URL that's down here  
[0:26:16](https://youtu.be/rsSld8NycCU?t=1576) what we loved about it is out of the box  
[0:26:19](https://youtu.be/rsSld8NycCU?t=1579) it has a number of serializers that will  
[0:26:21](https://youtu.be/rsSld8NycCU?t=1581) probably be good enough for your  
[0:26:23](https://youtu.be/rsSld8NycCU?t=1583) requirements for us we had a requirement  
[0:26:24](https://youtu.be/rsSld8NycCU?t=1584) that we needed to version our events  
[0:26:26](https://youtu.be/rsSld8NycCU?t=1586) because as people had noted requirements  
[0:26:28](https://youtu.be/rsSld8NycCU?t=1588) change and we need to be able to change  
[0:26:30](https://youtu.be/rsSld8NycCU?t=1590) with it easily so we wanted to stamp our  
[0:26:33](https://youtu.be/rsSld8NycCU?t=1593) events with versions so that way when we  
[0:26:36](https://youtu.be/rsSld8NycCU?t=1596) read in a version number we know what  
[0:26:37](https://youtu.be/rsSld8NycCU?t=1597) values to expect in the serialized data  
[0:26:39](https://youtu.be/rsSld8NycCU?t=1599) if it's not there we're going to provide  
[0:26:41](https://youtu.be/rsSld8NycCU?t=1601) a default value I  
[0:26:45](https://youtu.be/rsSld8NycCU?t=1605) so here's a visual representation of  
[0:26:47](https://youtu.be/rsSld8NycCU?t=1607) example of events in our data store so  
[0:26:50](https://youtu.be/rsSld8NycCU?t=1610) here we have two customers who've  
[0:26:52](https://youtu.be/rsSld8NycCU?t=1612) downloaded three titles if we focus on  
[0:26:54](https://youtu.be/rsSld8NycCU?t=1614) that here he downloaded house of cards  
[0:26:57](https://youtu.be/rsSld8NycCU?t=1617) and buddy thunderstruck there's no like  
[0:27:00](https://youtu.be/rsSld8NycCU?t=1620) values so the aggregate ID ordering  
[0:27:03](https://youtu.be/rsSld8NycCU?t=1623) doesn't take place here now let's say a  
[0:27:06](https://youtu.be/rsSld8NycCU?t=1626) little bit in time we move forward  
[0:27:07](https://youtu.be/rsSld8NycCU?t=1627) Matt's done with house of cards so he  
[0:27:09](https://youtu.be/rsSld8NycCU?t=1629) deletes it off his phone that's going to  
[0:27:11](https://youtu.be/rsSld8NycCU?t=1631) give us an event to tell us the license  
[0:27:13](https://youtu.be/rsSld8NycCU?t=1633) is no longer active and we're going to  
[0:27:14](https://youtu.be/rsSld8NycCU?t=1634) create event call it release license  
[0:27:17](https://youtu.be/rsSld8NycCU?t=1637) event now notice it's slid right under  
[0:27:21](https://youtu.be/rsSld8NycCU?t=1641) the first row reason for that is because  
[0:27:23](https://youtu.be/rsSld8NycCU?t=1643) it shares the same aggregate ID with the  
[0:27:26](https://youtu.be/rsSld8NycCU?t=1646) first row which is house of cards and  
[0:27:27](https://youtu.be/rsSld8NycCU?t=1647) we've told Cassandra we want to group  
[0:27:29](https://youtu.be/rsSld8NycCU?t=1649) these together once that grouping has  
[0:27:31](https://youtu.be/rsSld8NycCU?t=1651) been created when you are then going to  
[0:27:32](https://youtu.be/rsSld8NycCU?t=1652) sort it by the event time so since  
[0:27:34](https://youtu.be/rsSld8NycCU?t=1654) obviously 3° 0 it slides right under  
[0:27:37](https://youtu.be/rsSld8NycCU?t=1657) that first row what this gives us  
[0:27:39](https://youtu.be/rsSld8NycCU?t=1659) ability to do is to search Cassandra for  
[0:27:42](https://youtu.be/rsSld8NycCU?t=1662) specific aggregate and we do that by  
[0:27:45](https://youtu.be/rsSld8NycCU?t=1665) providing a row ID and the aggregate ID  
[0:27:47](https://youtu.be/rsSld8NycCU?t=1667) in this example we're going to get two  
[0:27:49](https://youtu.be/rsSld8NycCU?t=1669) events back they're going to be in the  
[0:27:51](https://youtu.be/rsSld8NycCU?t=1671) order we need to play them on top of our  
[0:27:53](https://youtu.be/rsSld8NycCU?t=1673) uninitialized events our aggregate I'm  
[0:27:55](https://youtu.be/rsSld8NycCU?t=1675) sorry and it's going to finalize them to  
[0:27:58](https://youtu.be/rsSld8NycCU?t=1678) a license I argue that's been released  
[0:28:01](https://youtu.be/rsSld8NycCU?t=1681) we also have the ability to ask  
[0:28:03](https://youtu.be/rsSld8NycCU?t=1683) Cassandra give me all the aggregates for  
[0:28:06](https://youtu.be/rsSld8NycCU?t=1686) this customer and we do that by simply  
[0:28:08](https://youtu.be/rsSld8NycCU?t=1688) providing the row ID now we have two  
[0:28:12](https://youtu.be/rsSld8NycCU?t=1692) distinct area IDs so in a repository  
[0:28:14](https://youtu.be/rsSld8NycCU?t=1694) processes this it's going to return back  
[0:28:17](https://youtu.be/rsSld8NycCU?t=1697) to aggregates one with house of cards  
[0:28:19](https://youtu.be/rsSld8NycCU?t=1699) which shows that it's been released one  
[0:28:21](https://youtu.be/rsSld8NycCU?t=1701) with buddy thunderstruck will show that  
[0:28:23](https://youtu.be/rsSld8NycCU?t=1703) it's still being used now a certain  
[0:28:26](https://youtu.be/rsSld8NycCU?t=1706) point in time there's you're going to  
[0:28:29](https://youtu.be/rsSld8NycCU?t=1709) create so many events that you just  
[0:28:31](https://youtu.be/rsSld8NycCU?t=1711) can't process them all it just doesn't  
[0:28:32](https://youtu.be/rsSld8NycCU?t=1712) make sense to process every event that  
[0:28:34](https://youtu.be/rsSld8NycCU?t=1714) has happened since the beginning of your  
[0:28:35](https://youtu.be/rsSld8NycCU?t=1715) service  
[0:28:36](https://youtu.be/rsSld8NycCU?t=1716) so this is where snapshotting comes in  
[0:28:39](https://youtu.be/rsSld8NycCU?t=1719) what you're going to do is the aggregate  
[0:28:41](https://youtu.be/rsSld8NycCU?t=1721) is going to set some conditions that say  
[0:28:43](https://youtu.be/rsSld8NycCU?t=1723) if any of these conditions are triggered  
[0:28:44](https://youtu.be/rsSld8NycCU?t=1724) create a snapshot of what we are and  
[0:28:46](https://youtu.be/rsSld8NycCU?t=1726) then from then on we're going to refer  
[0:28:49](https://youtu.be/rsSld8NycCU?t=1729) to the snapshot and move forward the  
[0:28:52](https://youtu.be/rsSld8NycCU?t=1732) triggers can be anything from how long  
[0:28:54](https://youtu.be/rsSld8NycCU?t=1734) it took to process all the events or the  
[0:28:55](https://youtu.be/rsSld8NycCU?t=1735) number of events that it did process  
[0:28:57](https://youtu.be/rsSld8NycCU?t=1737) either way  
[0:28:58](https://youtu.be/rsSld8NycCU?t=1738) we're going to take the materialized  
[0:29:00](https://youtu.be/rsSld8NycCU?t=1740) aggregates and we're going to serialize  
[0:29:02](https://youtu.be/rsSld8NycCU?t=1742) that and say that off to her database  
[0:29:04](https://youtu.be/rsSld8NycCU?t=1744) we're going to save it off to our  
[0:29:06](https://youtu.be/rsSld8NycCU?t=1746) snapshot table every aggregate starts  
[0:29:10](https://youtu.be/rsSld8NycCU?t=1750) off with no rows in the snapshot table  
[0:29:12](https://youtu.be/rsSld8NycCU?t=1752) so we have a default version of zero the  
[0:29:15](https://youtu.be/rsSld8NycCU?t=1755) row ID once again the aggregate is going  
[0:29:18](https://youtu.be/rsSld8NycCU?t=1758) to is responsible for defining its own  
[0:29:20](https://youtu.be/rsSld8NycCU?t=1760) snapshotting strategy so it's going to  
[0:29:23](https://youtu.be/rsSld8NycCU?t=1763) create its own row ID the version number  
[0:29:26](https://youtu.be/rsSld8NycCU?t=1766) as I say if it's not there at 0  
[0:29:27](https://youtu.be/rsSld8NycCU?t=1767) otherwise we wind up the number and the  
[0:29:29](https://youtu.be/rsSld8NycCU?t=1769) snapshot data this is going to be your  
[0:29:31](https://youtu.be/rsSld8NycCU?t=1771) list of aggregates that is serialized  
[0:29:34](https://youtu.be/rsSld8NycCU?t=1774) going back to our example let's say Matt  
[0:29:37](https://youtu.be/rsSld8NycCU?t=1777) triggers a snapshot so we end up taking  
[0:29:39](https://youtu.be/rsSld8NycCU?t=1779) the aggregates that we created and we  
[0:29:41](https://youtu.be/rsSld8NycCU?t=1781) save it off to the snapshot table we  
[0:29:44](https://youtu.be/rsSld8NycCU?t=1784) start with version number one since  
[0:29:45](https://youtu.be/rsSld8NycCU?t=1785) there wasn't one before we can get to it  
[0:29:48](https://youtu.be/rsSld8NycCU?t=1788) easy by the row ID  
[0:29:49](https://youtu.be/rsSld8NycCU?t=1789) it's just Matt and the aggregate name  
[0:29:51](https://youtu.be/rsSld8NycCU?t=1791) and the event data once again is a list  
[0:29:53](https://youtu.be/rsSld8NycCU?t=1793) of the aggregates in civilized form so  
[0:29:57](https://youtu.be/rsSld8NycCU?t=1797) the next time Matt makes a request we're  
[0:30:00](https://youtu.be/rsSld8NycCU?t=1800) going to look at the snapshot table  
[0:30:02](https://youtu.be/rsSld8NycCU?t=1802) first and gets the most recent version  
[0:30:04](https://youtu.be/rsSld8NycCU?t=1804) here it's version 1 well reading in the  
[0:30:07](https://youtu.be/rsSld8NycCU?t=1807) binary data and we'll create the list of  
[0:30:08](https://youtu.be/rsSld8NycCU?t=1808) aggregates then we'll go to our event  
[0:30:10](https://youtu.be/rsSld8NycCU?t=1810) table and we'll say we only want the  
[0:30:13](https://youtu.be/rsSld8NycCU?t=1813) events that happened after this snapshot  
[0:30:15](https://youtu.be/rsSld8NycCU?t=1815) and the way we do that is by appending  
[0:30:17](https://youtu.be/rsSld8NycCU?t=1817) the snapshot version at the end of our  
[0:30:18](https://youtu.be/rsSld8NycCU?t=1818) row ID so all the events that happened  
[0:30:21](https://youtu.be/rsSld8NycCU?t=1821) before our snapshot happened with the  
[0:30:24](https://youtu.be/rsSld8NycCU?t=1824) mat license aggregate and 0 at the end  
[0:30:26](https://youtu.be/rsSld8NycCU?t=1826) once the snapshot happened we start  
[0:30:29](https://youtu.be/rsSld8NycCU?t=1829) saving our events with the one at the  
[0:30:31](https://youtu.be/rsSld8NycCU?t=1831) end of the row ID so we'll take this  
[0:30:33](https://youtu.be/rsSld8NycCU?t=1833) single events and we'll apply it to the  
[0:30:35](https://youtu.be/rsSld8NycCU?t=1835) appropriate aggregate that we serialized  
[0:30:36](https://youtu.be/rsSld8NycCU?t=1836) and we'll move on from there  
[0:30:39](https://youtu.be/rsSld8NycCU?t=1839) so that's the general overview event  
[0:30:42](https://youtu.be/rsSld8NycCU?t=1842) solution I'm going to take it back to  
[0:30:43](https://youtu.be/rsSld8NycCU?t=1843) Pippa and she's going to describe what  
[0:30:44](https://youtu.be/rsSld8NycCU?t=1844) it's like to actually work with the  
[0:30:45](https://youtu.be/rsSld8NycCU?t=1845) system yeah thanks apparently it doesn't  
[0:30:50](https://youtu.be/rsSld8NycCU?t=1850) want me to talk to you people I'm sorry  
[0:30:53](https://youtu.be/rsSld8NycCU?t=1853) alright so everyone knows designing a  
[0:30:55](https://youtu.be/rsSld8NycCU?t=1855) new system implementing a new system  
[0:30:57](https://youtu.be/rsSld8NycCU?t=1857) it's fun you get to play with things but  
[0:31:00](https://youtu.be/rsSld8NycCU?t=1860) then you get to have to work with this  
[0:31:01](https://youtu.be/rsSld8NycCU?t=1861) new system so what's it like after we  
[0:31:04](https://youtu.be/rsSld8NycCU?t=1864) release this has it been like working on  
[0:31:07](https://youtu.be/rsSld8NycCU?t=1867) and iterating on the license accounting  
[0:31:09](https://youtu.be/rsSld8NycCU?t=1869) service so I'm going to go back and rear  
[0:31:12](https://youtu.be/rsSld8NycCU?t=1872) you ate those four key points that I  
[0:31:14](https://youtu.be/rsSld8NycCU?t=1874) went through before and talked about how  
[0:31:17](https://youtu.be/rsSld8NycCU?t=1877) it's being in practice so what was  
[0:31:19](https://youtu.be/rsSld8NycCU?t=1879) flexibility like and practice Robert  
[0:31:22](https://youtu.be/rsSld8NycCU?t=1882) mentioned prior we mentioned how we  
[0:31:23](https://youtu.be/rsSld8NycCU?t=1883) conversion they're vents and the  
[0:31:25](https://youtu.be/rsSld8NycCU?t=1885) aggregates and when we can create new  
[0:31:27](https://youtu.be/rsSld8NycCU?t=1887) fields we do this on a regular basis  
[0:31:29](https://youtu.be/rsSld8NycCU?t=1889) where all we have to do is go into the  
[0:31:31](https://youtu.be/rsSld8NycCU?t=1891) actual Java object add a new field to  
[0:31:33](https://youtu.be/rsSld8NycCU?t=1893) the object and create an annotated  
[0:31:35](https://youtu.be/rsSld8NycCU?t=1895) version on that it's really easy I'm not  
[0:31:37](https://youtu.be/rsSld8NycCU?t=1897) going to go into that because of the  
[0:31:39](https://youtu.be/rsSld8NycCU?t=1899) simplicity instead what I'm going to do  
[0:31:41](https://youtu.be/rsSld8NycCU?t=1901) is deep dive into something that's a  
[0:31:42](https://youtu.be/rsSld8NycCU?t=1902) little bit more interesting I'm going to  
[0:31:45](https://youtu.be/rsSld8NycCU?t=1905) talk about a new business requirement  
[0:31:47](https://youtu.be/rsSld8NycCU?t=1907) that we had recently which required us  
[0:31:48](https://youtu.be/rsSld8NycCU?t=1908) to create a whole new demand model a  
[0:31:50](https://youtu.be/rsSld8NycCU?t=1910) whole new aggregate so this requirement  
[0:31:54](https://youtu.be/rsSld8NycCU?t=1914) was that you could now go onto the  
[0:31:56](https://youtu.be/rsSld8NycCU?t=1916) website select manage download devices  
[0:31:59](https://youtu.be/rsSld8NycCU?t=1919) and you can remotely deactivate one of  
[0:32:02](https://youtu.be/rsSld8NycCU?t=1922) your devices this means if you lose your  
[0:32:04](https://youtu.be/rsSld8NycCU?t=1924) device or you want to free up a slot you  
[0:32:06](https://youtu.be/rsSld8NycCU?t=1926) can go online and basically release all  
[0:32:09](https://youtu.be/rsSld8NycCU?t=1929) the licenses and have that content  
[0:32:11](https://youtu.be/rsSld8NycCU?t=1931) removed from a device however we only  
[0:32:15](https://youtu.be/rsSld8NycCU?t=1935) want you to do this a certain number of  
[0:32:16](https://youtu.be/rsSld8NycCU?t=1936) times a year so we need to maintain  
[0:32:18](https://youtu.be/rsSld8NycCU?t=1938) state now and record how many activate  
[0:32:22](https://youtu.be/rsSld8NycCU?t=1942) devices happened over the course of a  
[0:32:23](https://youtu.be/rsSld8NycCU?t=1943) year whole new flow on your domain model  
[0:32:28](https://youtu.be/rsSld8NycCU?t=1948) so let's talk about the components which  
[0:32:30](https://youtu.be/rsSld8NycCU?t=1950) are required to do this let's step  
[0:32:32](https://youtu.be/rsSld8NycCU?t=1952) through them first thing is we're going  
[0:32:34](https://youtu.be/rsSld8NycCU?t=1954) to need a new endpoint for the service  
[0:32:36](https://youtu.be/rsSld8NycCU?t=1956) to actually answer the request on we're  
[0:32:39](https://youtu.be/rsSld8NycCU?t=1959) going to need a new device service that  
[0:32:40](https://youtu.be/rsSld8NycCU?t=1960) as Robert said has our business  
[0:32:42](https://youtu.be/rsSld8NycCU?t=1962) requirements layer this is where we say  
[0:32:44](https://youtu.be/rsSld8NycCU?t=1964) are you allowed to deactivate the device  
[0:32:46](https://youtu.be/rsSld8NycCU?t=1966) or any other potential device  
[0:32:47](https://youtu.be/rsSld8NycCU?t=1967) functionality thirdly the device  
[0:32:50](https://youtu.be/rsSld8NycCU?t=1970) repository which will interact with the  
[0:32:52](https://youtu.be/rsSld8NycCU?t=1972) device aggregate and create the device  
[0:32:54](https://youtu.be/rsSld8NycCU?t=1974) aggregate for us and finally we're going  
[0:32:57](https://youtu.be/rsSld8NycCU?t=1977) to need for this case scenario a new  
[0:32:59](https://youtu.be/rsSld8NycCU?t=1979) device didn't you deactivate device  
[0:33:02](https://youtu.be/rsSld8NycCU?t=1982) command and device deactivated event so  
[0:33:06](https://youtu.be/rsSld8NycCU?t=1986) these are the new components that we  
[0:33:07](https://youtu.be/rsSld8NycCU?t=1987) needed for this workflow how do they  
[0:33:09](https://youtu.be/rsSld8NycCU?t=1989) work together we have the flow where the  
[0:33:12](https://youtu.be/rsSld8NycCU?t=1992) endpoint will actually talk to the  
[0:33:14](https://youtu.be/rsSld8NycCU?t=1994) device service and say go do deactivate  
[0:33:16](https://youtu.be/rsSld8NycCU?t=1996) my device for me the device service will  
[0:33:19](https://youtu.be/rsSld8NycCU?t=1999) now ask that question can we deactivate  
[0:33:22](https://youtu.be/rsSld8NycCU?t=2002) the device it will look at the device  
[0:33:24](https://youtu.be/rsSld8NycCU?t=2004) aggregate which he gets from the device  
[0:33:26](https://youtu.be/rsSld8NycCU?t=2006) and it will say how many times is this  
[0:33:29](https://youtu.be/rsSld8NycCU?t=2009) person deactivate a device in the last  
[0:33:31](https://youtu.be/rsSld8NycCU?t=2011) year in this case it's only one so we'll  
[0:33:33](https://youtu.be/rsSld8NycCU?t=2013) say okay well let you have this  
[0:33:35](https://youtu.be/rsSld8NycCU?t=2015) deactivation so can deactivate is true  
[0:33:37](https://youtu.be/rsSld8NycCU?t=2017) at this point the device servers can use  
[0:33:39](https://youtu.be/rsSld8NycCU?t=2019) the licensed service to release all the  
[0:33:42](https://youtu.be/rsSld8NycCU?t=2022) licenses for that device and then  
[0:33:44](https://youtu.be/rsSld8NycCU?t=2024) finally it'll use the device repository  
[0:33:46](https://youtu.be/rsSld8NycCU?t=2026) which will apply the device aggregate  
[0:33:48](https://youtu.be/rsSld8NycCU?t=2028) and the device command to the command  
[0:33:51](https://youtu.be/rsSld8NycCU?t=2031) handler and create a new event that says  
[0:33:54](https://youtu.be/rsSld8NycCU?t=2034) this has happened we've now deactivated  
[0:33:56](https://youtu.be/rsSld8NycCU?t=2036) that device so all of these components  
[0:34:00](https://youtu.be/rsSld8NycCU?t=2040) using the architecture that Robert just  
[0:34:02](https://youtu.be/rsSld8NycCU?t=2042) described or extensible components easy  
[0:34:06](https://youtu.be/rsSld8NycCU?t=2046) to add easy to extend the top-level  
[0:34:08](https://youtu.be/rsSld8NycCU?t=2048) aggregate repository command and event  
[0:34:12](https://youtu.be/rsSld8NycCU?t=2052) as a result putting in this entire flow  
[0:34:16](https://youtu.be/rsSld8NycCU?t=2056) code completions are creating all of  
[0:34:19](https://youtu.be/rsSld8NycCU?t=2059) those components from scratch during the  
[0:34:22](https://youtu.be/rsSld8NycCU?t=2062) unit testing doing the smoke testing the  
[0:34:24](https://youtu.be/rsSld8NycCU?t=2064) integration testing the device  
[0:34:26](https://youtu.be/rsSld8NycCU?t=2066) testing everything in order to get this  
[0:34:28](https://youtu.be/rsSld8NycCU?t=2068) out into production took me under a week  
[0:34:31](https://youtu.be/rsSld8NycCU?t=2071) to do me just one person never once did  
[0:34:36](https://youtu.be/rsSld8NycCU?t=2076) I have to touch the devote their  
[0:34:37](https://youtu.be/rsSld8NycCU?t=2077) database I didn't have to make direct  
[0:34:39](https://youtu.be/rsSld8NycCU?t=2079) changes to the database all of this was  
[0:34:41](https://youtu.be/rsSld8NycCU?t=2081) done in the application Java layer I  
[0:34:43](https://youtu.be/rsSld8NycCU?t=2083) didn't have to have any understanding of  
[0:34:45](https://youtu.be/rsSld8NycCU?t=2085) how the integration with Cassandra  
[0:34:46](https://youtu.be/rsSld8NycCU?t=2086) happened at all so I think this is a  
[0:34:50](https://youtu.be/rsSld8NycCU?t=2090) pretty good example of the flexibility  
[0:34:52](https://youtu.be/rsSld8NycCU?t=2092) that we got out of this architecture  
[0:34:54](https://youtu.be/rsSld8NycCU?t=2094) that anyone could come in that's new to  
[0:34:56](https://youtu.be/rsSld8NycCU?t=2096) our team and be able to have a pretty  
[0:34:58](https://youtu.be/rsSld8NycCU?t=2098) quick learning curve to get up to the  
[0:35:01](https://youtu.be/rsSld8NycCU?t=2101) ability to make these sort of changes so  
[0:35:03](https://youtu.be/rsSld8NycCU?t=2103) what about debug ability for me I think  
[0:35:06](https://youtu.be/rsSld8NycCU?t=2106) this is actually the biggest win so we  
[0:35:09](https://youtu.be/rsSld8NycCU?t=2109) have some really rudimentary tooling  
[0:35:11](https://youtu.be/rsSld8NycCU?t=2111) where you need to get a bit better at  
[0:35:12](https://youtu.be/rsSld8NycCU?t=2112) this but all we have at the moment is we  
[0:35:15](https://youtu.be/rsSld8NycCU?t=2115) have an elastic search log of every  
[0:35:17](https://youtu.be/rsSld8NycCU?t=2117) single request that comes into our  
[0:35:18](https://youtu.be/rsSld8NycCU?t=2118) server and we have an endpoint which  
[0:35:21](https://youtu.be/rsSld8NycCU?t=2121) gives us a event dump for a customer it  
[0:35:24](https://youtu.be/rsSld8NycCU?t=2124) just gives us all of the events that the  
[0:35:26](https://youtu.be/rsSld8NycCU?t=2126) customers had in JSON format for us to  
[0:35:28](https://youtu.be/rsSld8NycCU?t=2128) look through so even with this really  
[0:35:30](https://youtu.be/rsSld8NycCU?t=2130) rudimentary logging we've been able to  
[0:35:32](https://youtu.be/rsSld8NycCU?t=2132) debug some pretty interesting edge case  
[0:35:34](https://youtu.be/rsSld8NycCU?t=2134) conditions and I'm gonna go through one  
[0:35:36](https://youtu.be/rsSld8NycCU?t=2136) of the examples now so what we noticed  
[0:35:39](https://youtu.be/rsSld8NycCU?t=2139) was we noticed that  
[0:35:40](https://youtu.be/rsSld8NycCU?t=2140) his devices occasionally happening where  
[0:35:43](https://youtu.be/rsSld8NycCU?t=2143) they had licenses or they had downloads  
[0:35:45](https://youtu.be/rsSld8NycCU?t=2145) on the device which weren't being  
[0:35:47](https://youtu.be/rsSld8NycCU?t=2147) counted by our server we weren't  
[0:35:49](https://youtu.be/rsSld8NycCU?t=2149) validating them properly so we went and  
[0:35:52](https://youtu.be/rsSld8NycCU?t=2152) we got that dump of all the events and  
[0:35:54](https://youtu.be/rsSld8NycCU?t=2154) we stepped through and what we saw was  
[0:35:56](https://youtu.be/rsSld8NycCU?t=2156) we had to start with an acquire licence  
[0:35:58](https://youtu.be/rsSld8NycCU?t=2158) event good that's what we want this is  
[0:36:01](https://youtu.be/rsSld8NycCU?t=2161) followed by a few of the lifecycle  
[0:36:02](https://youtu.be/rsSld8NycCU?t=2162) events that we have in our system and  
[0:36:04](https://youtu.be/rsSld8NycCU?t=2164) then we saw a release event perfect  
[0:36:06](https://youtu.be/rsSld8NycCU?t=2166) that's what we want and our in your  
[0:36:08](https://youtu.be/rsSld8NycCU?t=2168) event wait we've just renewed a release  
[0:36:12](https://youtu.be/rsSld8NycCU?t=2172) of license  
[0:36:13](https://youtu.be/rsSld8NycCU?t=2173) this license is meant to be closed why  
[0:36:16](https://youtu.be/rsSld8NycCU?t=2176) are we renewing it what's going on here  
[0:36:18](https://youtu.be/rsSld8NycCU?t=2178) so what was happening was rear ending up  
[0:36:22](https://youtu.be/rsSld8NycCU?t=2182) getting a license aggregate that was  
[0:36:24](https://youtu.be/rsSld8NycCU?t=2184) released so we weren't counting it but  
[0:36:27](https://youtu.be/rsSld8NycCU?t=2187) was continuing to be extended so we were  
[0:36:30](https://youtu.be/rsSld8NycCU?t=2190) able to go through these events and say  
[0:36:32](https://youtu.be/rsSld8NycCU?t=2192) okay  
[0:36:33](https://youtu.be/rsSld8NycCU?t=2193) that renew license event happened at  
[0:36:34](https://youtu.be/rsSld8NycCU?t=2194) this point in time we could correlate  
[0:36:37](https://youtu.be/rsSld8NycCU?t=2197) that to the device logs and we could see  
[0:36:40](https://youtu.be/rsSld8NycCU?t=2200) what was happening on the device and we  
[0:36:42](https://youtu.be/rsSld8NycCU?t=2202) could step through it and we're able to  
[0:36:44](https://youtu.be/rsSld8NycCU?t=2204) help with the device team to actually  
[0:36:46](https://youtu.be/rsSld8NycCU?t=2206) identify a bug on the client which had  
[0:36:49](https://youtu.be/rsSld8NycCU?t=2209) an edge case condition that was reusing  
[0:36:52](https://youtu.be/rsSld8NycCU?t=2212) the license ID the aggregate ID and  
[0:36:54](https://youtu.be/rsSld8NycCU?t=2214) hence continuing to keep from acting on  
[0:36:56](https://youtu.be/rsSld8NycCU?t=2216) it but it also identified a bug in our  
[0:37:00](https://youtu.be/rsSld8NycCU?t=2220) code  
[0:37:00](https://youtu.be/rsSld8NycCU?t=2220) can anyone see something we're doing  
[0:37:03](https://youtu.be/rsSld8NycCU?t=2223) wrong here we should never be renewing  
[0:37:06](https://youtu.be/rsSld8NycCU?t=2226) that license this should be an invalid  
[0:37:10](https://youtu.be/rsSld8NycCU?t=2230) state transaction when Robert mentioned  
[0:37:12](https://youtu.be/rsSld8NycCU?t=2232) before about the command handling acting  
[0:37:15](https://youtu.be/rsSld8NycCU?t=2235) on invalid state this is invalid state  
[0:37:17](https://youtu.be/rsSld8NycCU?t=2237) we should never move a release license  
[0:37:20](https://youtu.be/rsSld8NycCU?t=2240) into renewed state that is an invalid  
[0:37:22](https://youtu.be/rsSld8NycCU?t=2242) state transaction and it should be  
[0:37:24](https://youtu.be/rsSld8NycCU?t=2244) caught by the command handler so we were  
[0:37:26](https://youtu.be/rsSld8NycCU?t=2246) able to fix this bug on our system and  
[0:37:27](https://youtu.be/rsSld8NycCU?t=2247) our site as well all right so what about  
[0:37:30](https://youtu.be/rsSld8NycCU?t=2250) the reliability I mentioned before that  
[0:37:32](https://youtu.be/rsSld8NycCU?t=2252) we have fallback so let's throw that to  
[0:37:34](https://youtu.be/rsSld8NycCU?t=2254) that when the client when the device  
[0:37:37](https://youtu.be/rsSld8NycCU?t=2257) makes a call to us it hits our Eid JPI  
[0:37:39](https://youtu.be/rsSld8NycCU?t=2259) layer and on the edge API layer we have  
[0:37:41](https://youtu.be/rsSld8NycCU?t=2261) a license accounting service client it's  
[0:37:44](https://youtu.be/rsSld8NycCU?t=2264) a rest client that talks directly to our  
[0:37:46](https://youtu.be/rsSld8NycCU?t=2266) license accounting service that service  
[0:37:48](https://youtu.be/rsSld8NycCU?t=2268) in turn talks to Cassandra so we had two  
[0:37:51](https://youtu.be/rsSld8NycCU?t=2271) points of failure here  
[0:37:53](https://youtu.be/rsSld8NycCU?t=2273) if either one of those fail we could  
[0:37:57](https://youtu.be/rsSld8NycCU?t=2277) then disrupt client experience so we  
[0:37:59](https://youtu.be/rsSld8NycCU?t=2279) need to make sure that this doesn't  
[0:38:01](https://youtu.be/rsSld8NycCU?t=2281) happen if our failure occurs you  
[0:38:04](https://youtu.be/rsSld8NycCU?t=2284) shouldn't be punished for that so what  
[0:38:06](https://youtu.be/rsSld8NycCU?t=2286) we have is we have a default fallback  
[0:38:08](https://youtu.be/rsSld8NycCU?t=2288) response this acts as if you'd never had  
[0:38:11](https://youtu.be/rsSld8NycCU?t=2291) any licenses if you've never had any  
[0:38:14](https://youtu.be/rsSld8NycCU?t=2294) downloads given that scenario what would  
[0:38:16](https://youtu.be/rsSld8NycCU?t=2296) the response be so we err on the side of  
[0:38:19](https://youtu.be/rsSld8NycCU?t=2299) customer experience this gives us an  
[0:38:22](https://youtu.be/rsSld8NycCU?t=2302) ability to have an outage and you'll  
[0:38:24](https://youtu.be/rsSld8NycCU?t=2304) never even know and we have had one very  
[0:38:27](https://youtu.be/rsSld8NycCU?t=2307) brief outage and no one you do better  
[0:38:31](https://youtu.be/rsSld8NycCU?t=2311) so this definitely has helped us with  
[0:38:32](https://youtu.be/rsSld8NycCU?t=2312) reliability lastly I'm sure this is what  
[0:38:35](https://youtu.be/rsSld8NycCU?t=2315) you all want to hear how did it scare  
[0:38:38](https://youtu.be/rsSld8NycCU?t=2318) you all so the service itself scaled  
[0:38:42](https://youtu.be/rsSld8NycCU?t=2322) really well from the very first day we  
[0:38:44](https://youtu.be/rsSld8NycCU?t=2324) actually pinned high so that we could  
[0:38:46](https://youtu.be/rsSld8NycCU?t=2326) get an idea of what the traffic was  
[0:38:47](https://youtu.be/rsSld8NycCU?t=2327) going to be and then after we had a good  
[0:38:50](https://youtu.be/rsSld8NycCU?t=2330) log of what traffic was we moved to our  
[0:38:53](https://youtu.be/rsSld8NycCU?t=2333) Scryer predictive scaling service i'm  
[0:38:55](https://youtu.be/rsSld8NycCU?t=2335) not going to deep drive you can actually  
[0:38:56](https://youtu.be/rsSld8NycCU?t=2336) look there's some tech blogs we could  
[0:38:58](https://youtu.be/rsSld8NycCU?t=2338) talk about what spur is but it basically  
[0:39:00](https://youtu.be/rsSld8NycCU?t=2340) looks at what customer traffic was and  
[0:39:01](https://youtu.be/rsSld8NycCU?t=2341) uses that to predict how much we should  
[0:39:03](https://youtu.be/rsSld8NycCU?t=2343) scale the service in the future so the  
[0:39:05](https://youtu.be/rsSld8NycCU?t=2345) service code really will what we had  
[0:39:08](https://youtu.be/rsSld8NycCU?t=2348) problems with was the Cassandra nodes  
[0:39:12](https://youtu.be/rsSld8NycCU?t=2352) the Cassandra nodes which we used were  
[0:39:16](https://youtu.be/rsSld8NycCU?t=2356) very very very high throughput low  
[0:39:18](https://youtu.be/rsSld8NycCU?t=2358) latency nodes really great for serving  
[0:39:20](https://youtu.be/rsSld8NycCU?t=2360) traffic however they had a relatively  
[0:39:24](https://youtu.be/rsSld8NycCU?t=2364) low amount of storage so what we saw  
[0:39:27](https://youtu.be/rsSld8NycCU?t=2367) pretty soon was this pretty graph which  
[0:39:31](https://youtu.be/rsSld8NycCU?t=2371) shows this lovely green line of disk  
[0:39:34](https://youtu.be/rsSld8NycCU?t=2374) storage rapidly reaching hundred percent  
[0:39:38](https://youtu.be/rsSld8NycCU?t=2378) so while the blue line shows the  
[0:39:43](https://youtu.be/rsSld8NycCU?t=2383) requests and the throughput for the  
[0:39:44](https://youtu.be/rsSld8NycCU?t=2384) service and we could handle way more  
[0:39:46](https://youtu.be/rsSld8NycCU?t=2386) requests than what we currently got the  
[0:39:48](https://youtu.be/rsSld8NycCU?t=2388) amount of nodes we had was not keeping  
[0:39:50](https://youtu.be/rsSld8NycCU?t=2390) up with the amount of data we had all  
[0:39:52](https://youtu.be/rsSld8NycCU?t=2392) right easy double the cost up done right  
[0:39:55](https://youtu.be/rsSld8NycCU?t=2395) yeah how scalable is that that's not  
[0:39:57](https://youtu.be/rsSld8NycCU?t=2397) going to work we need to find better  
[0:40:00](https://youtu.be/rsSld8NycCU?t=2400) solutions we need to architect better  
[0:40:01](https://youtu.be/rsSld8NycCU?t=2401) solutions for our storage so what are  
[0:40:04](https://youtu.be/rsSld8NycCU?t=2404) some options we  
[0:40:06](https://youtu.be/rsSld8NycCU?t=2406) good look into details however this was  
[0:40:09](https://youtu.be/rsSld8NycCU?t=2409) a few months of data and we have to  
[0:40:10](https://youtu.be/rsSld8NycCU?t=2410) store this for the next year even then  
[0:40:13](https://youtu.be/rsSld8NycCU?t=2413) there's edge case conditions that we  
[0:40:15](https://youtu.be/rsSld8NycCU?t=2415) have this life cycle so you can't just  
[0:40:16](https://youtu.be/rsSld8NycCU?t=2416) drop events off and we don't really want  
[0:40:18](https://youtu.be/rsSld8NycCU?t=2418) to that's the point of events or so we  
[0:40:20](https://youtu.be/rsSld8NycCU?t=2420) want to keep this data so there's  
[0:40:22](https://youtu.be/rsSld8NycCU?t=2422) another option AWS offers a different  
[0:40:24](https://youtu.be/rsSld8NycCU?t=2424) storage optimize cluster called the d2  
[0:40:27](https://youtu.be/rsSld8NycCU?t=2427) clusters these have much more storage  
[0:40:30](https://youtu.be/rsSld8NycCU?t=2430) capacities these have in the order of  
[0:40:32](https://youtu.be/rsSld8NycCU?t=2432) terabytes now but the disadvantage is  
[0:40:36](https://youtu.be/rsSld8NycCU?t=2436) they have much higher latency up to one  
[0:40:39](https://youtu.be/rsSld8NycCU?t=2439) second that's not really going to cut a  
[0:40:44](https://youtu.be/rsSld8NycCU?t=2444) real-time service like this so why am I  
[0:40:46](https://youtu.be/rsSld8NycCU?t=2446) even to mentioning this what about a  
[0:40:48](https://youtu.be/rsSld8NycCU?t=2448) petition approach what if we took that  
[0:40:52](https://youtu.be/rsSld8NycCU?t=2452) SSD I to cluster that really quick low  
[0:40:55](https://youtu.be/rsSld8NycCU?t=2455) latency cluster and we use that to serve  
[0:40:58](https://youtu.be/rsSld8NycCU?t=2458) the snapshot in subsequent events so as  
[0:41:00](https://youtu.be/rsSld8NycCU?t=2460) Robert described when we snapshot data  
[0:41:02](https://youtu.be/rsSld8NycCU?t=2462) we take the they'll take the current of  
[0:41:07](https://youtu.be/rsSld8NycCU?t=2467) course a aggregate thank you we take the  
[0:41:10](https://youtu.be/rsSld8NycCU?t=2470) current aggregate and then we serialize  
[0:41:12](https://youtu.be/rsSld8NycCU?t=2472) that and then we only replay any  
[0:41:14](https://youtu.be/rsSld8NycCU?t=2474) subsequent events on to that aggregate  
[0:41:16](https://youtu.be/rsSld8NycCU?t=2476) we're not really looking at the events  
[0:41:18](https://youtu.be/rsSld8NycCU?t=2478) that came before it they're still there  
[0:41:20](https://youtu.be/rsSld8NycCU?t=2480) or we still use them for debugging  
[0:41:21](https://youtu.be/rsSld8NycCU?t=2481) purposes but they're not used for the  
[0:41:23](https://youtu.be/rsSld8NycCU?t=2483) real-time requests so what if we took  
[0:41:27](https://youtu.be/rsSld8NycCU?t=2487) that snapshot and any subsequent events  
[0:41:30](https://youtu.be/rsSld8NycCU?t=2490) and that's always stored on those SSD  
[0:41:32](https://youtu.be/rsSld8NycCU?t=2492) nodes then for the d2 drives the ones  
[0:41:37](https://youtu.be/rsSld8NycCU?t=2497) with more disk space for those we can  
[0:41:40](https://youtu.be/rsSld8NycCU?t=2500) actually store all of the events and we  
[0:41:42](https://youtu.be/rsSld8NycCU?t=2502) can use that for debugging purposes  
[0:41:43](https://youtu.be/rsSld8NycCU?t=2503) which isn't real-time when a one-second  
[0:41:45](https://youtu.be/rsSld8NycCU?t=2505) delay isn't going to be the end of the  
[0:41:46](https://youtu.be/rsSld8NycCU?t=2506) world so what if we take this one step  
[0:41:49](https://youtu.be/rsSld8NycCU?t=2509) further how many of you have heard of  
[0:41:51](https://youtu.be/rsSld8NycCU?t=2511) CQRS okay for those of you who have an I  
[0:41:55](https://youtu.be/rsSld8NycCU?t=2515) apologize I'm not going to deep dive on  
[0:41:57](https://youtu.be/rsSld8NycCU?t=2517) it to that much today but just let me  
[0:41:59](https://youtu.be/rsSld8NycCU?t=2519) say it's where you segregate  
[0:42:01](https://youtu.be/rsSld8NycCU?t=2521) your command and query responsibility  
[0:42:03](https://youtu.be/rsSld8NycCU?t=2523) this means that you can write depending  
[0:42:06](https://youtu.be/rsSld8NycCU?t=2526) on the use case two different storage  
[0:42:07](https://youtu.be/rsSld8NycCU?t=2527) mechanisms and can read depending on the  
[0:42:10](https://youtu.be/rsSld8NycCU?t=2530) business use case the business  
[0:42:11](https://youtu.be/rsSld8NycCU?t=2531) requirements two different storage so in  
[0:42:14](https://youtu.be/rsSld8NycCU?t=2534) this case what we could have is we could  
[0:42:16](https://youtu.be/rsSld8NycCU?t=2536) have a write segregation where we have  
[0:42:17](https://youtu.be/rsSld8NycCU?t=2537) an event handler which determines  
[0:42:19](https://youtu.be/rsSld8NycCU?t=2539) and where to write snapshots too and  
[0:42:21](https://youtu.be/rsSld8NycCU?t=2541) then where to write events to and how to  
[0:42:24](https://youtu.be/rsSld8NycCU?t=2544) write those events to which rose  
[0:42:25](https://youtu.be/rsSld8NycCU?t=2545) dependent on the storage which is going  
[0:42:27](https://youtu.be/rsSld8NycCU?t=2547) into then you can have an a query  
[0:42:30](https://youtu.be/rsSld8NycCU?t=2550) segregate ur and the query segregation  
[0:42:32](https://youtu.be/rsSld8NycCU?t=2552) could determine where it's going to read  
[0:42:34](https://youtu.be/rsSld8NycCU?t=2554) from if this is a real-time event coming  
[0:42:36](https://youtu.be/rsSld8NycCU?t=2556) in for validation for a customer that  
[0:42:38](https://youtu.be/rsSld8NycCU?t=2558) needs a response right now it can go  
[0:42:40](https://youtu.be/rsSld8NycCU?t=2560) straight to the I to node and say here's  
[0:42:42](https://youtu.be/rsSld8NycCU?t=2562) your response if it's a debug request it  
[0:42:46](https://youtu.be/rsSld8NycCU?t=2566) can go and get all of the events and get  
[0:42:48](https://youtu.be/rsSld8NycCU?t=2568) them and bring them back with a  
[0:42:50](https://youtu.be/rsSld8NycCU?t=2570) one-second latency which is fine or we  
[0:42:53](https://youtu.be/rsSld8NycCU?t=2573) could even have both happening at the  
[0:42:54](https://youtu.be/rsSld8NycCU?t=2574) same time we could go and do both and  
[0:42:57](https://youtu.be/rsSld8NycCU?t=2577) then if we have any failure which  
[0:42:59](https://youtu.be/rsSld8NycCU?t=2579) happens to the i2 instance for any  
[0:43:01](https://youtu.be/rsSld8NycCU?t=2581) reason we've still got this backup being  
[0:43:03](https://youtu.be/rsSld8NycCU?t=2583) processed which we can then use from the  
[0:43:04](https://youtu.be/rsSld8NycCU?t=2584) d2 instance so let's go now and recap  
[0:43:09](https://youtu.be/rsSld8NycCU?t=2589) what we've just looked at flexibility  
[0:43:14](https://youtu.be/rsSld8NycCU?t=2594) this system the event sourcing system  
[0:43:17](https://youtu.be/rsSld8NycCU?t=2597) definitely gave us the flexibility that  
[0:43:19](https://youtu.be/rsSld8NycCU?t=2599) we wanted we were able to very quickly  
[0:43:21](https://youtu.be/rsSld8NycCU?t=2601) iterate and create new changes the  
[0:43:23](https://youtu.be/rsSld8NycCU?t=2603) domain model react to business  
[0:43:25](https://youtu.be/rsSld8NycCU?t=2605) requirements immediately and get the  
[0:43:28](https://youtu.be/rsSld8NycCU?t=2608) changes out into production it's given  
[0:43:30](https://youtu.be/rsSld8NycCU?t=2610) us exactly what we wanted and it's given  
[0:43:32](https://youtu.be/rsSld8NycCU?t=2612) us in the application layer never do we  
[0:43:35](https://youtu.be/rsSld8NycCU?t=2615) have to touch the database but since  
[0:43:36](https://youtu.be/rsSld8NycCU?t=2616) we've like since we've released this we  
[0:43:39](https://youtu.be/rsSld8NycCU?t=2619) have never directly had to touch the  
[0:43:40](https://youtu.be/rsSld8NycCU?t=2620) database it's all been doing the  
[0:43:43](https://youtu.be/rsSld8NycCU?t=2623) application layer debug ability as I  
[0:43:47](https://youtu.be/rsSld8NycCU?t=2627) said one of my favorite things being  
[0:43:49](https://youtu.be/rsSld8NycCU?t=2629) able to pinpoint exactly when a state  
[0:43:51](https://youtu.be/rsSld8NycCU?t=2631) change happened that caused an invalid  
[0:43:54](https://youtu.be/rsSld8NycCU?t=2634) state that happened ages ago and your  
[0:43:57](https://youtu.be/rsSld8NycCU?t=2637) any notice to it now and then being able  
[0:44:00](https://youtu.be/rsSld8NycCU?t=2640) to go back and look at all the logs  
[0:44:01](https://youtu.be/rsSld8NycCU?t=2641) associated with that really helps  
[0:44:03](https://youtu.be/rsSld8NycCU?t=2643) pinpoint exactly where things might have  
[0:44:04](https://youtu.be/rsSld8NycCU?t=2644) gone wrong reliability the fall backs  
[0:44:07](https://youtu.be/rsSld8NycCU?t=2647) definitely helped us with that  
[0:44:09](https://youtu.be/rsSld8NycCU?t=2649) scalability the service definitely  
[0:44:11](https://youtu.be/rsSld8NycCU?t=2651) scaled well however as I said we do need  
[0:44:13](https://youtu.be/rsSld8NycCU?t=2653) to find good architectural solutions to  
[0:44:15](https://youtu.be/rsSld8NycCU?t=2655) make sure that we are utilizing the  
[0:44:17](https://youtu.be/rsSld8NycCU?t=2657) storage properly so in conclusion I want  
[0:44:21](https://youtu.be/rsSld8NycCU?t=2661) to bring up that go back to the  
[0:44:23](https://youtu.be/rsSld8NycCU?t=2663) beginning of last year none of us really  
[0:44:25](https://youtu.be/rsSld8NycCU?t=2665) had a good idea of what event sourcing  
[0:44:27](https://youtu.be/rsSld8NycCU?t=2667) was when you were as an abstract concept  
[0:44:30](https://youtu.be/rsSld8NycCU?t=2670) we had no idea what the intricacies were  
[0:44:32](https://youtu.be/rsSld8NycCU?t=2672) or how  
[0:44:33](https://youtu.be/rsSld8NycCU?t=2673) go about implementing it since then  
[0:44:36](https://youtu.be/rsSld8NycCU?t=2676) we've implemented a solution that is  
[0:44:38](https://youtu.be/rsSld8NycCU?t=2678) flexible debuggable reliable and  
[0:44:40](https://youtu.be/rsSld8NycCU?t=2680) scalable and we've been using it on a  
[0:44:42](https://youtu.be/rsSld8NycCU?t=2682) daily basis successfully and so I just  
[0:44:45](https://youtu.be/rsSld8NycCU?t=2685) want to say this is something that you  
[0:44:46](https://youtu.be/rsSld8NycCU?t=2686) can do too and we hope that you can come  
[0:44:49](https://youtu.be/rsSld8NycCU?t=2689) up with us give us questions give us  
[0:44:51](https://youtu.be/rsSld8NycCU?t=2691) have a conversation with us and let us  
[0:44:53](https://youtu.be/rsSld8NycCU?t=2693) know what you think  
[0:44:54](https://youtu.be/rsSld8NycCU?t=2694) thank you all right we have a few  
[0:45:05](https://youtu.be/rsSld8NycCU?t=2705) questions here hi in your example you  
[0:45:12](https://youtu.be/rsSld8NycCU?t=2712) showed ID in your example you showed row  
[0:45:17](https://youtu.be/rsSld8NycCU?t=2717) ID as a customer ID and you can  
[0:45:18](https://youtu.be/rsSld8NycCU?t=2718) aggregate by port that customer how many  
[0:45:22](https://youtu.be/rsSld8NycCU?t=2722) active movies can you activate buy  
[0:45:25](https://youtu.be/rsSld8NycCU?t=2725) property soft customer like region he  
[0:45:28](https://youtu.be/rsSld8NycCU?t=2728) belongs to our age group you belongs to  
[0:45:31](https://youtu.be/rsSld8NycCU?t=2731) yes so the way it works is the aggregate  
[0:45:33](https://youtu.be/rsSld8NycCU?t=2733) repository ties to a single aggregate  
[0:45:36](https://youtu.be/rsSld8NycCU?t=2736) and there's a function in the repository  
[0:45:38](https://youtu.be/rsSld8NycCU?t=2738) that says give me the row ID so the the  
[0:45:42](https://youtu.be/rsSld8NycCU?t=2742) area itself is responsible for defining  
[0:45:44](https://youtu.be/rsSld8NycCU?t=2744) the row ID so like I said simply we'll  
[0:45:46](https://youtu.be/rsSld8NycCU?t=2746) just use the name of the IRA --get  
[0:45:48](https://youtu.be/rsSld8NycCU?t=2748) followed by the customer ID but there's  
[0:45:50](https://youtu.be/rsSld8NycCU?t=2750) nothing to stop you from putting about  
[0:45:52](https://youtu.be/rsSld8NycCU?t=2752) you on there so if you want to partition  
[0:45:53](https://youtu.be/rsSld8NycCU?t=2753) by not only an aggregate and its  
[0:45:56](https://youtu.be/rsSld8NycCU?t=2756) customer but by a value your it's really  
[0:45:58](https://youtu.be/rsSld8NycCU?t=2758) simple to do it's just a one-line change  
[0:46:00](https://youtu.be/rsSld8NycCU?t=2760) of code hello thanks for the  
[0:46:06](https://youtu.be/rsSld8NycCU?t=2766) presentation I'm curious to know how do  
[0:46:08](https://youtu.be/rsSld8NycCU?t=2768) you guys deal with changes in the scheme  
[0:46:11](https://youtu.be/rsSld8NycCU?t=2771) of the event payloads over time yeah so  
[0:46:19](https://youtu.be/rsSld8NycCU?t=2779) we use the cryo versioning so if we have  
[0:46:23](https://youtu.be/rsSld8NycCU?t=2783) a change like let me think of something  
[0:46:26](https://youtu.be/rsSld8NycCU?t=2786) recent yeah if we needed to add the  
[0:46:33](https://youtu.be/rsSld8NycCU?t=2793) request ID so we had some D duping on  
[0:46:35](https://youtu.be/rsSld8NycCU?t=2795) request ID so for us to actually change  
[0:46:37](https://youtu.be/rsSld8NycCU?t=2797) the schema to include the request ID so  
[0:46:39](https://youtu.be/rsSld8NycCU?t=2799) that we could actually act on that in  
[0:46:40](https://youtu.be/rsSld8NycCU?t=2800) the future it's just a matter of adding  
[0:46:42](https://youtu.be/rsSld8NycCU?t=2802) the field to the aggregate as well as  
[0:46:44](https://youtu.be/rsSld8NycCU?t=2804) the event which we have that idea  
[0:46:46](https://youtu.be/rsSld8NycCU?t=2806) on and then we version that and so we  
[0:46:49](https://youtu.be/rsSld8NycCU?t=2809) know any subsequent aggregates that have  
[0:46:51](https://youtu.be/rsSld8NycCU?t=2811) been using that version will actually  
[0:46:53](https://youtu.be/rsSld8NycCU?t=2813) set that request ID and then we can  
[0:46:54](https://youtu.be/rsSld8NycCU?t=2814) check to see if it's there and act on it  
[0:46:56](https://youtu.be/rsSld8NycCU?t=2816) as needed and the way we set the version  
[0:46:58](https://youtu.be/rsSld8NycCU?t=2818) in is cryo has annotations so you could  
[0:47:00](https://youtu.be/rsSld8NycCU?t=2820) say there's an annotation Adsense and  
[0:47:02](https://youtu.be/rsSld8NycCU?t=2822) you basically wind up that number so  
[0:47:05](https://youtu.be/rsSld8NycCU?t=2825) when you want to create a new version  
[0:47:06](https://youtu.be/rsSld8NycCU?t=2826) because he added a new field you just  
[0:47:08](https://youtu.be/rsSld8NycCU?t=2828) put you annotator with that sense  
[0:47:10](https://youtu.be/rsSld8NycCU?t=2830) whatever the largest number is went up  
[0:47:12](https://youtu.be/rsSld8NycCU?t=2832) it and stamp it with that so that's how  
[0:47:13](https://youtu.be/rsSld8NycCU?t=2833) cryo stamps the version on the events  
[0:47:15](https://youtu.be/rsSld8NycCU?t=2835) when it sterilizes it that being said  
[0:47:17](https://youtu.be/rsSld8NycCU?t=2837) I'll say versioning was by far one of  
[0:47:20](https://youtu.be/rsSld8NycCU?t=2840) the hardest things we ever had to do  
[0:47:21](https://youtu.be/rsSld8NycCU?t=2841) it's just one of the things we couldn't  
[0:47:23](https://youtu.be/rsSld8NycCU?t=2843) wrap our head around I think we deleted  
[0:47:26](https://youtu.be/rsSld8NycCU?t=2846) a lot of scratch databases before we  
[0:47:28](https://youtu.be/rsSld8NycCU?t=2848) felt comfortable moving with what we had  
[0:47:31](https://youtu.be/rsSld8NycCU?t=2851) so be careful Carl's great and all gives  
[0:47:34](https://youtu.be/rsSld8NycCU?t=2854) you what you need but it's not going to  
[0:47:36](https://youtu.be/rsSld8NycCU?t=2856) solve all your problems you still gotta  
[0:47:37](https://youtu.be/rsSld8NycCU?t=2857) wrap your head around this system if  
[0:47:38](https://youtu.be/rsSld8NycCU?t=2858) you're interested we do actually had an  
[0:47:40](https://youtu.be/rsSld8NycCU?t=2860) example we had to remove it for time but  
[0:47:43](https://youtu.be/rsSld8NycCU?t=2863) you can come and have a look and I'll  
[0:47:44](https://youtu.be/rsSld8NycCU?t=2864) show you how it's done  
[0:47:45](https://youtu.be/rsSld8NycCU?t=2865) [Music]  
[0:47:46](https://youtu.be/rsSld8NycCU?t=2866) my question is about aggregates and an  
[0:47:51](https://youtu.be/rsSld8NycCU?t=2871) event sourcing how do you enforce  
[0:47:55](https://youtu.be/rsSld8NycCU?t=2875) invariants the way you were speaking I  
[0:48:00](https://youtu.be/rsSld8NycCU?t=2880) could get sort just pretty much just  
[0:48:03](https://youtu.be/rsSld8NycCU?t=2883) data is that is that it and the  
[0:48:06](https://youtu.be/rsSld8NycCU?t=2886) conditions and states are enforced  
[0:48:08](https://youtu.be/rsSld8NycCU?t=2888) somewhere else or how does it work so we  
[0:48:12](https://youtu.be/rsSld8NycCU?t=2892) do have the two enforcement layers so we  
[0:48:14](https://youtu.be/rsSld8NycCU?t=2894) do have the service layer which does  
[0:48:16](https://youtu.be/rsSld8NycCU?t=2896) actually validate so the aggregate is  
[0:48:18](https://youtu.be/rsSld8NycCU?t=2898) the data essentially but the data has  
[0:48:20](https://youtu.be/rsSld8NycCU?t=2900) been validated prior to being added so  
[0:48:22](https://youtu.be/rsSld8NycCU?t=2902) before actually adding those events we  
[0:48:24](https://youtu.be/rsSld8NycCU?t=2904) do validate to make sure that they can  
[0:48:27](https://youtu.be/rsSld8NycCU?t=2907) affect the data if they're not allowed  
[0:48:28](https://youtu.be/rsSld8NycCU?t=2908) to affect the data then they don't get  
[0:48:30](https://youtu.be/rsSld8NycCU?t=2910) at it in the first place but there's no  
[0:48:32](https://youtu.be/rsSld8NycCU?t=2912) actual condition once they're in them  
[0:48:34](https://youtu.be/rsSld8NycCU?t=2914) once they're in there it's done like  
[0:48:36](https://youtu.be/rsSld8NycCU?t=2916) you're done this is immutable  
[0:48:38](https://youtu.be/rsSld8NycCU?t=2918) whatever has happened has happened and  
[0:48:39](https://youtu.be/rsSld8NycCU?t=2919) here's the current state based on that  
[0:48:41](https://youtu.be/rsSld8NycCU?t=2921) you can change going forward and you can  
[0:48:43](https://youtu.be/rsSld8NycCU?t=2923) change the validation going forward for  
[0:48:45](https://youtu.be/rsSld8NycCU?t=2925) those events and you can say those  
[0:48:47](https://youtu.be/rsSld8NycCU?t=2927) events aren't allowed to have this field  
[0:48:48](https://youtu.be/rsSld8NycCU?t=2928) going forward for example but you can't  
[0:48:51](https://youtu.be/rsSld8NycCU?t=2931) change that past about having the  
[0:48:53](https://youtu.be/rsSld8NycCU?t=2933) service layer the service layer right  
[0:48:56](https://youtu.be/rsSld8NycCU?t=2936) now says the download limits only three  
[0:48:58](https://youtu.be/rsSld8NycCU?t=2938) it's really easy for us  
[0:49:00](https://youtu.be/rsSld8NycCU?t=2940) change that download service to like  
[0:49:01](https://youtu.be/rsSld8NycCU?t=2941) five or ten and we didn't change  
[0:49:03](https://youtu.be/rsSld8NycCU?t=2943) anything in the code now the service  
[0:49:05](https://youtu.be/rsSld8NycCU?t=2945) layer is aware and updated and what was  
[0:49:07](https://youtu.be/rsSld8NycCU?t=2947) previously rejected to you is now going  
[0:49:08](https://youtu.be/rsSld8NycCU?t=2948) to pass into you know the new upper  
[0:49:10](https://youtu.be/rsSld8NycCU?t=2950) limit yeah have you considered to keep  
[0:49:15](https://youtu.be/rsSld8NycCU?t=2955) the snapshot inside the device like  
[0:49:18](https://youtu.be/rsSld8NycCU?t=2958) inside the mobile device or inside the  
[0:49:20](https://youtu.be/rsSld8NycCU?t=2960) device that is basically requesting the  
[0:49:23](https://youtu.be/rsSld8NycCU?t=2963) the movies good that's up to device  
[0:49:27](https://youtu.be/rsSld8NycCU?t=2967) teams I don't think they were under  
[0:49:30](https://youtu.be/rsSld8NycCU?t=2970) their own pressure to deliver this  
[0:49:32](https://youtu.be/rsSld8NycCU?t=2972) download service to everybody so I don't  
[0:49:34](https://youtu.be/rsSld8NycCU?t=2974) think us coming to them and saying you  
[0:49:35](https://youtu.be/rsSld8NycCU?t=2975) know could you store all this data for  
[0:49:37](https://youtu.be/rsSld8NycCU?t=2977) us they that's part of something we  
[0:49:39](https://youtu.be/rsSld8NycCU?t=2979) would have been pushed back on so it was  
[0:49:41](https://youtu.be/rsSld8NycCU?t=2981) it's a toesik store law that state yeah  
[0:49:46](https://youtu.be/rsSld8NycCU?t=2986) okay so let's make this the last  
[0:49:48](https://youtu.be/rsSld8NycCU?t=2988) question right so I was curious about  
[0:49:52](https://youtu.be/rsSld8NycCU?t=2992) when you request the repository am i  
[0:49:56](https://youtu.be/rsSld8NycCU?t=2996) authorize it to get a new license do you  
[0:49:59](https://youtu.be/rsSld8NycCU?t=2999) give back some sort of token saying that  
[0:50:03](https://youtu.be/rsSld8NycCU?t=3003) these guy is retrieving a new license or  
[0:50:05](https://youtu.be/rsSld8NycCU?t=3005) you just say yes or not the a great idea  
[0:50:09](https://youtu.be/rsSld8NycCU?t=3009) is the token actually so I use generic  
[0:50:11](https://youtu.be/rsSld8NycCU?t=3011) examples or just at house of cards it's  
[0:50:13](https://youtu.be/rsSld8NycCU?t=3013) actually a UUID and we call that the  
[0:50:15](https://youtu.be/rsSld8NycCU?t=3015) license ID so the license ID and the  
[0:50:17](https://youtu.be/rsSld8NycCU?t=3017) aggregate ID are the same thing so I'll  
[0:50:19](https://youtu.be/rsSld8NycCU?t=3019) hand the license to the device devices  
[0:50:21](https://youtu.be/rsSld8NycCU?t=3021) takes note of the license ID and it  
[0:50:22](https://youtu.be/rsSld8NycCU?t=3022) stores it with the license so let's say  
[0:50:25](https://youtu.be/rsSld8NycCU?t=3025) the device wants to delete the license  
[0:50:28](https://youtu.be/rsSld8NycCU?t=3028) and wants to let us know that the  
[0:50:29](https://youtu.be/rsSld8NycCU?t=3029) license has been deleted it's going to  
[0:50:30](https://youtu.be/rsSld8NycCU?t=3030) send us the delete event but it's also  
[0:50:32](https://youtu.be/rsSld8NycCU?t=3032) going to send us the license ID check  
[0:50:34](https://youtu.be/rsSld8NycCU?t=3034) the license ID and we'll use that as the  
[0:50:35](https://youtu.be/rsSld8NycCU?t=3035) aggregate ID to get it is actually a  
[0:50:38](https://youtu.be/rsSld8NycCU?t=3038) token as well so it does store  
[0:50:40](https://youtu.be/rsSld8NycCU?t=3040) information about the transaction which  
[0:50:42](https://youtu.be/rsSld8NycCU?t=3042) we can use alright well thank you very  
[0:50:45](https://youtu.be/rsSld8NycCU?t=3045) much everybody thank you so much  

